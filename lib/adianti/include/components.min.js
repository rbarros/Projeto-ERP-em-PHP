function tdialog_start(e,t){$.fn.modal.Constructor.prototype._enforceFocus=function(){};$(e).modal({backdrop:true,keyboard:true});if(typeof t!="undefined"){$(e).on("hidden.bs.modal",function(){t();tdialog_close(e.substring(1))})}else{$(e).on("hidden.bs.modal",function(){tdialog_close(e.substring(1))})}}function tdialog_close(e){$(".modal-backdrop").last().remove();$("#"+e).modal("hide");$("body").removeClass("modal-open");setTimeout(function(){$("#"+e).remove()},300)}function tjquerydialog_start(e,t,a,n,i,r,o,s,l,c,d,f,u){if($(e).parent().attr("role")=="window-wrapper"){var p="#"+$(e).parent().attr("id")}else{var p="body"}$(e).dialog({modal:t,stack:false,zIndex:2e3,draggable:a,resizable:n,closeOnEscape:f,height:r,width:i,appendTo:p,dialogClass:u,beforeClose:function(){if(typeof d=="function"){d();return false}return true},close:function(e,t){$(this).remove();$(".tooltip.fade").remove();var a=$(this).attr("name");$("[window_name="+a+"]").remove()},buttons:c});$(".ui-dialog").last().focus();$(e).closest(".ui-dialog").css({zIndex:l});$(".ui-widget-overlay").css({zIndex:100});if(o>0){$(e).closest(".ui-dialog").css({top:o+"px"})}if(s>0){$(e).closest(".ui-dialog").css({left:s+"px"})}}function tjquerydialog_block_ui(){$(document).ready(function(){$(".ui-dialog").css("pointer-events","none");$(".ui-dialog-content").css("opacity","0.5")})}function tjquerydialog_unblock_ui(){$(".ui-dialog").css("pointer-events","all");$(".ui-dialog-content").css("opacity","")}function tform_send_data(n,e,t,i,a){if(parseInt(a)>0){setTimeout(function(){tform_send_data(n,e,t,i,0)},a);return}try{if(e.substr(0,1)=="#"){var r=$(e);var o=[];var s=[]}else{var r=$("form[name="+n+"] [name='"+e+"']");var o=$("form[name="+n+"] [name='"+e+"[]']");var s=$("form[name="+n+"] [widget='tmultifile'][name='file_"+e+"[]']")}if(r.length||o.length||s){if(typeof Adianti.formEventsCounter=="undefined"||Number.isNaN(Adianti.formEventsCounter)){Adianti.formEventsCounter=0}if(Adianti.formEventsCounter==0){if(s.length){try{s[0].tmultifile.send_data(JSON.parse(t))}catch(e){s[0].tmultifile.setValue(t)}}else if(r.length){if(r.attr("widget")=="thtmleditor"){r.summernote("code",t)}if(r.attr("widget")=="tcolor"){r.colorpicker("setValue",t)}else if(r.attr("widget")=="timagecropper"){r[0].timagecropper.setValue(t)}else if(r.attr("widget")=="tfile"){r[0].tfile.setValue(t)}else if(r.attr("role")=="tcombosearch"){if(r.val()!==t){var l=function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}};r.select2({templateResult:l,templateSelection:l}).val(t).trigger("change.select2")}}else if(r.attr("widget")=="tdbuniquesearch"){var c=i;tdbuniquesearch_set_value(n,e,t,function(){if(c){if(r.attr("exitaction")){tform_events_hang_exec(r.attr("exitaction"))}if(r.attr("changeaction")){tform_events_hang_exec(r.attr("changeaction"))}}});i=false}else if(r.attr("component")=="multisearch"){if(t){var l=function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}};r.select2({templateResult:l,templateSelection:l}).val(t).trigger("change.select2")}}else if(r.attr("type")=="radio"||r.attr("type")=="checkbox"){if(t){var d=r.filter("[value="+t+"]").prop("checked",true);if(d.parent().prop("tagName")=="LABEL"){d.parent().parent().find("label").removeClass("active");d.parent().toggleClass("active")}}}else{r.val(t)}if(i){if(r.attr("exitaction")){tform_events_hang_exec(r.attr("exitaction"))}if(r.attr("changeaction")){tform_events_hang_exec(r.attr("changeaction"))}}}else if(o.length){if(o.attr("type")=="checkbox"){o.prop("checked",false);if(t){o.parent().parent().find("label").removeClass("active");var f=JSON.parse(t);$.each(f,function(e,t){var a=o.filter("[value="+t+"]").prop("checked",true);if(a.parent().prop("tagName")=="LABEL"){a.parent().toggleClass("active")}})}}else if(o.attr("component")=="multientry"){if(t){o.empty();var u=JSON.parse(t);$.each(u,function(e,t){o.append($("<option/>").val(t).text(t))});o.val(u).trigger("change.select2")}}else if(o.attr("component")=="multisearch"&&o.attr("widget")!=="tuniquesearch"){if(t){var u=JSON.parse(t);var l=function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}};if(o.attr("widget")=="tmultisearch"||o.attr("widget")=="tdbmultisearch"){o.select2({templateResult:l,templateSelection:l}).val(u).trigger("change.select2")}else{$.each(u,function(e,t){var a=$($(o)[e]).attr("id");tform_send_data(n,"#"+a,t,i)});i=false}}}else if(o.length){if(t){var u=JSON.parse(t);$(o).find("option").prop("selected",false);if(o.attr("widget")=="tselect"&&o.length==1){$.each(u,function(e,t){$(o).find("option").filter('[value="'+t+'"]').prop("selected",true)})}else{$.each(u,function(e,t){var a=$($(o)[e]).attr("id");tform_send_data(n,"#"+a,t,i)});i=false}}}if(i){if(o.attr("exitaction")){tform_events_hang_exec(o.attr("exitaction"))}if(o.attr("changeaction")){tform_events_hang_exec(o.attr("changeaction"))}}}}else{tform_events_queue_push(function(){tform_send_data(n,e,t,i)})}}}catch(e){console.log(e)}}function tform_send_data_by_id(e,t,a,n,i){if(parseInt(i)>0){setTimeout(function(){tform_send_data_by_id(e,t,a,n,0)},i);return}try{if($("form[name="+e+"] [id="+t+"]").length){if(typeof Adianti.formEventsCounter=="undefined"||Number.isNaN(Adianti.formEventsCounter)){Adianti.formEventsCounter=0}if(Adianti.formEventsCounter==0){$("form[name="+e+"] [id="+t+"]").val(a);if(n){if($("form[name="+e+"] [id="+t+"]").attr("exitaction")){tform_events_hang_exec($("form[name="+e+"] [id="+t+"]").attr("exitaction"))}if($("form[name="+e+"] [id="+t+"]").attr("changeaction")){tform_events_hang_exec($("form[name="+e+"] [id="+t+"]").attr("changeaction"))}}}else{tform_events_queue_push(function(){tform_send_data_by_id(e,t,a,n)})}}}catch(e){console.log(e)}}function tform_events_hang_exec(e){if(typeof Adianti.formEventsCounter=="undefined"||Number.isNaN(Adianti.formEventsCounter)){Adianti.formEventsCounter=0}Adianti.formEventsCounter++;e=e.replace("'callback'","tform_decrease_events_counter");Function(e)()}function tform_events_stop(e){Adianti.formEventsStop=e}function tform_events_queue_push(e){if(typeof Adianti.formEventsQueue=="undefined"){Adianti.formEventsQueue=new Array}Adianti.formEventsQueue.push(e);setTimeout(tform_process_events_queue,100)}function tform_process_events_queue(){if(typeof Adianti.formEventsCounter=="undefined"||Number.isNaN(Adianti.formEventsCounter)){Adianti.formEventsCounter=0}if(Adianti.formEventsCounter==0&&Adianti.formEventsQueue.length>0){next=Adianti.formEventsQueue.shift();next()}if(Adianti.formEventsQueue.length>0){setTimeout(tform_process_events_queue,100)}else{if(typeof Adianti.formEventsStop=="function"){Adianti.formEventsStop();Adianti.formEventsStop=null}}}function tform_decrease_events_counter(){if(typeof Adianti.formEventsCounter=="undefined"||Number.isNaN(Adianti.formEventsCounter)){Adianti.formEventsCounter=0}Adianti.formEventsCounter--}function tform_send_data_aggregate(e,t,a,n){try{if($("form[name="+e+"] [name="+t+"]").val()==""){$("form[name="+e+"] [name="+t+"]").val(a)}else{current_value=$("form[name="+e+"] [name="+t+"]").val();$("form[name="+e+"] [name="+t+"]").val(current_value+", "+a)}}catch(e){console.log(e)}}function tform_fire_field_actions(e,t){if($("form[name="+e+"] [name="+t+"]").attr("exitaction")){tform_events_hang_exec($("form[name="+e+"] [name="+t+"]").attr("exitaction"))}if($("form[name="+e+"] [name="+t+"]").attr("changeaction")){tform_events_hang_exec($("form[name="+e+"] [name="+t+"]").attr("changeaction"))}}function tform_hide_field(e,t,a){if(typeof a=="undefined"){$("#"+e+' [name="'+t+'"]').closest(".tformrow").hide("fast")}else{$("#"+e+' [name="'+t+'"]').closest(".tformrow").hide(a)}}function tform_show_field(e,t,a){if(typeof a=="undefined"){$("#"+e+' [name="'+t+'"]').closest(".tformrow").show("fast")}else{$("#"+e+' [name="'+t+'"]').closest(".tformrow").show(a)}}function ttable_clone_previous_row(e){var t=$(e).closest("table");var a=t.find("tbody tr:last");var n=a.clone();tfieldlist_reset_fields(n,true);t.find("tbody").append(n);ttable_reset_counter(t)}function ttable_clone_row(e){var t=$(e).closest("tr");var a=$(e).closest("table");var n=t.prev();var i=t.clone();tfieldlist_reset_fields(i,false);t.after($(i));ttable_reset_counter(a)}function ttable_reset_counter(e){var n=0;var t=$(e).find("tr").each(function(e,t){var a=$(t).find("input,select");$(t).data("row",n);if(a.length>0){$.each(a,function(e,t){$(t).data("row",n)});n++}})}function ttable_remove_row(n){setTimeout(function(){var e=$(n).closest("table");var t=e.find("tbody").find("tr:visible").length;tr=$(n).closest("tr");if(t==1){var a=tr.clone();tfieldlist_reset_fields(a,true);tr.after($(a));tr.remove()}else{tr.remove()}ttable_reset_counter(e)},10)}function ttable_remove_row_by_id(e,t){$("#"+e).find("tr[id="+t+"]").remove()}function ttable_show_row(e,t){$("#"+e).find("tr#"+t).show()}function ttable_hide_row(e,t){$("#"+e).find("tr#"+t).hide()}function ttable_sortable_rows(e,t,a){$(document).ready(function(){$("#"+e+" tbody").sortable({handle:t,deactivate:a})})}function ttable_get_column_values(e,t){return $("#"+e+" tbody").find("tr").find("td:nth-child("+t+")").map(function(){return this.innerText}).get().join(",")}function ttable_add_row(e,t,a){$("#"+e+" tbody").append(base64_decode(a))}function ttable_replace_row_by_id(e,t,a){if($("#"+e+" tbody").find("#"+t).length>0){$("#"+e+" tbody").find("#"+t).replaceWith(base64_decode(a))}else{$("#"+e+" tbody").append(base64_decode(a))}}function tfieldlist_reset_fields(m,_){var h=parseInt(Math.random()*1e8);$(m).attr("id",h);var e=$(m).find("input,select");var v=[];$.each(e,function(e,t){var a=$(t).attr("id");var n=$(t).attr("widget");var i=$(t).attr("role");if(typeof a!=="undefined"){var r=a.split("_");r.pop();var o=r.join("_");var s=o+"_"+h;var l=$(t).parent();if(v.indexOf(s)>=0){var s=o+parseInt(Math.random()*100)+"_"+h}v.push(s);if(n=="tdate"||n=="ttime"||n=="tdatetime"){$(t).attr("id",s);if(_){$(t).val("")}if(typeof $(t).attr("exitaction")!=="undefined"){$(t).attr("exitaction",$(t).attr("exitaction").replace(a,s))}if(typeof $(t).attr("onblur")!=="undefined"){$(t).attr("onblur",$(t).attr("onblur").replace(a,s))}grandparent=$(l).parent();t=$(t).detach();$(l).remove();grandparent.append(t);var c=n;if(n=="ttime"){var c="tdatetime"}var d=new RegExp(a,"g");tfieldlist_execute_scripts(grandparent,c,function(e){e=e.replace(d,s);return e})}else if(n=="tentry"){$(t).attr("id",s);if(_){$(t).val("")}if(typeof $(t).attr("exitaction")!=="undefined"){$(t).attr("exitaction",$(t).attr("exitaction").replace(a,s))}if(typeof $(t).attr("onblur")!=="undefined"){$(t).attr("onblur",$(t).attr("onblur").replace(a,s))}var d=new RegExp(a,"g");tfieldlist_execute_scripts(l,"tentry",function(e){e=e.replace(d,s);return e})}else if(n=="tspinner"){$(t).attr("id",s);if(_){$(t).val("")}if(typeof $(t).attr("exitaction")!=="undefined"){$(t).attr("exitaction",$(t).attr("exitaction").replace(a,s))}if(typeof $(t).attr("onblur")!=="undefined"){$(t).attr("onblur",$(t).attr("onblur").replace(a,s))}grandparent=$(l).parent();t=$(t).detach();$(l).remove();grandparent.append(t);var d=new RegExp(a,"g");tfieldlist_execute_scripts(grandparent,"tspinner",function(e){e=e.replace(d,s);return e})}else if(n=="tcolor"){$(t).attr("id",s);if(_){$(t).val("")}if(typeof $(t).attr("exitaction")!=="undefined"){$(t).attr("exitaction",$(t).attr("exitaction").replace(a,s))}if(typeof $(t).attr("onblur")!=="undefined"){$(t).attr("onblur",$(t).attr("onblur").replace(a,s))}grandparent=$(l).parent();var d=new RegExp(a,"g");tfieldlist_execute_scripts(grandparent,"tcolor",function(e){e=e.replace(d,s);return e})}else if(n=="thidden"){$(t).attr("id",s);if($(t).attr("uniqid")=="true"){$(t).val(parseInt(Math.random()*1e10))}else if(_){$(t).val("")}var d=new RegExp(a,"g");tfieldlist_execute_scripts(l,"thidden",function(e){e=e.replace(d,s);return e})}else if(n=="tdbmultisearch"||n=="tdbuniquesearch"){$(t).attr("id",s);$(t).removeData("select2-id").removeAttr("data-select2-id").find("option").removeAttr("data-select2-id");$(m).removeData("select2-id").removeAttr("data-select2-id");$(l).find(".select2-container").remove();var d=new RegExp(a,"g");tfieldlist_execute_scripts(l,"tdbmultisearch",function(e){e=e.replace(d,s);return e});if(_){setTimeout(function(){$(t).val("").trigger("change.select2")},10)}}else if(n=="tmultisearch"||n=="tuniquesearch"){$(t).attr("id",s);$(t).removeData("select2-id").removeAttr("data-select2-id").find("option").removeAttr("data-select2-id");$(m).removeData("select2-id").removeAttr("data-select2-id");$(l).find(".select2-container").remove();var d=new RegExp(a,"g");tfieldlist_execute_scripts(l,"tmultisearch",function(e){e=e.replace(d,s);return e});if(_){setTimeout(function(){$(t).val("").trigger("change.select2")},10)}}else if(n=="tcombo"){$(t).attr("id",s);if(_){$(t).val("")}if(i=="tcombosearch"){$(t).removeData("select2-id").removeAttr("data-select2-id").find("option").removeAttr("data-select2-id");$(m).removeData("select2-id").removeAttr("data-select2-id");$(l).find(".select2-container").remove()}if(typeof $(t).attr("changeaction")!=="undefined"){$(t).attr("changeaction",$(t).attr("changeaction").replace(a,s))}if(typeof $(t).attr("onchange")!=="undefined"){$(t).attr("onchange",$(t).attr("onchange").replace(a,s))}var d=new RegExp(a,"g");tfieldlist_execute_scripts(l,"tcombo",function(e){e=e.replace(d,s);return e})}else if(n=="tfile"){$(t).attr("id",s);if(_){$(t).val("")}var l=$(t).closest("td");var f=l.find(".div_file").attr("id");var u="div_file_"+h;l.find(".tfile_row_wrapper").remove();l.find(".file-response-icon").remove();l.find(".div_file").attr("id",u);$(t).css("padding-left","5px");if(typeof $(t).attr("changeaction")!=="undefined"){$(t).attr("changeaction",$(t).attr("changeaction").replace(a,s))}if(typeof $(t).attr("onchange")!=="undefined"){$(t).attr("onchange",$(t).attr("onchange").replace(a,s))}var d=new RegExp(a,"g");var p=new RegExp(f,"g");tfieldlist_execute_scripts(l,"tfile",function(e){e=e.replace(d,s);e=e.replace(p,u);return e})}}if(n=="tradiobutton"){$(t).parent().removeClass("active")}else if(n=="tcheckbutton"){$(t).parent().removeClass("active")}})}function tfieldlist_execute_scripts(e,n,i){var t=$(e).find("script");$.each(t,function(e,t){var a=$(t).text();a=i(a);if(a.trim().split("_")[0]==n){$(t).text(a);setTimeout(function(){new Function(a)()},10)}})}function tfieldlist_clear(e){ttable_clone_previous_row($("[name="+e+"] tbody"));var a=$("[name="+e+"] tbody").find("tr").length-1;$("[name="+e+"] tbody").find("tr").each(function(e,t){if(e<a){ttable_remove_row(t)}});$("[name="+e+"] tfoot").find('input[type="text"]').each(function(e,t){tfieldlist_update_sum($(t).attr("field_name"))})}function tfieldlist_add_rows(e,t,a){a=a?a:50;for(n=1;n<=t;n++){setTimeout(function(){ttable_clone_previous_row($("[name="+e+"] tbody"))},a*n)}}function tfieldlist_clear_rows(e,a,n){var t=$("[name="+e+"] tbody").find("tr").length;n=(n==0?t:n)+a;if(n>=t){ttable_clone_previous_row($("[name="+e+"] tbody").find("tr:last"));n=t}$("[name="+e+"] tbody").find("tr").each(function(e,t){if(e>=a&&e<n){$(t).remove()}})}function tfieldlist_get_last_row_data(e){var n={};n.index=$(e).closest("table").find("tbody tr:last").index();$(e).closest("table").find("tbody tr:last").find("[name]").each(function(e,t){var a=$(t).attr("name");a=a.replace("[]","");n[a]=$(t).val()});return n}function tfieldlist_get_row_data(e){var n={};n.index=$(e).closest("tr").index();n["_row_id"]=$(e).closest("tr").attr("id");$(e).closest("tr").find("[name]").each(function(e,t){var a=$(t).attr("name");a=a.replace("[]","");n[a]=$(t).val()});return n}function tfieldlist_column_sum(e){var n=0;$('[name="'+e+'[]"]').each(function(e,t){var a=tentry_get_data_by_id($(t).attr("id"));if(!isNaN(parseFloat(a))){n+=parseFloat(a)}});return n}function tfieldlist_update_sum(t,a){setTimeout(function(){var e=tfieldlist_column_sum(t);$("[name=grandtotal_"+t+"]").val(number_format(e,2,",","."));if(a&&typeof a==="function"){a()}},50)}function tdatagrid_inlineedit(a){$(function(){$(".inlineediting").editInPlace({callback:function(e,t){__adianti_load_page($(this).attr("action")+a+"&key="+$(this).attr("key")+"&"+$(this).attr("pkey")+"="+$(this).attr("key")+"&field="+$(this).attr("field")+"&value="+encodeURIComponent(t));return t},show_buttons:false,text_size:20,params:column=name})})}function tdatagrid_add_serialized_row(e,t){$("#"+e+" > tbody:last-child").append(t)}function tdatagrid_enable_groups(){$("[id^=tdatagrid_] tr[level]").not("[x=1]").css("cursor","pointer").attr("x","1").click(function(){if(!$(this).data("child-visible")){$(this).data("child-visible",false)}$(this).data("child-visible",!$(this).data("child-visible"));if($(this).data("child-visible")){$(this).siblings('[childof="'+$(this).attr("level")+'"]').hide("fast")}else{$(this).siblings('[childof="'+$(this).attr("level")+'"]').show("fast")}})}function tdatagrid_update_total(a){var l=a.substring(1);var e=document.querySelector(a);var t=new MutationObserver(function(e){e.forEach(function(e){if(e.target.tagName=="TBODY"){var t=$(a).find("[data-total-function=sum]");var s=0;t.each(function(e,t){var a=$(t).data("column-name");var n=$(t).data("total-mask");var i=n.split(":");if(i.length>0){var r=i[0];var o=i[1]}else{var r="";var o=n.substring(1)}$('[name="'+l+"_"+a+'[]"]').each(function(e,t){s+=parseFloat($(t).val())});$(t).html(r+" "+number_format(s,o.substring(0,1),o.substring(1,2),o.substring(2,3)));$(t).data("value",s);$(t).attr("data-value",s)})}})});var n={attributes:true,childList:true,characterData:true,subtree:true,attributeOldValue:true,characterDataOldValue:true};t.observe(e,n)}function tbutton_enable_field(e,t){setTimeout(function(){$("button[name="+t+"]").removeAttr("disabled");$("button[name=btn_"+t+"]").removeAttr("disabled");$("#tbutton_"+t).removeAttr("disabled")},1)}function tbutton_disable_field(e,t){setTimeout(function(){$("button[name="+t+"]").attr("disabled",true);$("button[name=btn_"+t+"]").attr("disabled",true);$("#tbutton_"+t).attr("disabled",true)},1)}function tcheckgroup_enable_field(e,t){setTimeout(function(){$("form[name="+e+"] [checkgroup="+t+"]").attr("onclick",null);$("form[name="+e+"] [checkgroup="+t+"]").css("pointer-events","auto");$("form[name="+e+"] [checkgroup="+t+"]").parent().css("pointer-events","auto");$("form[name="+e+"] [checkgroup="+t+"]").parent().removeAttr("disabled");$("form[name="+e+"] [checkgroup="+t+"]").parent().css("color","")},1)}function tcheckgroup_disable_field(e,t){setTimeout(function(){$("form[name="+e+"] [checkgroup="+t+"]").attr("onclick","return false");$("form[name="+e+"] [checkgroup="+t+"]").css("pointer-events","none");$("form[name="+e+"] [checkgroup="+t+"]").parent().css("pointer-events","none");$("form[name="+e+"] [checkgroup="+t+"]").parent().attr("disabled","");$("form[name="+e+"] [checkgroup="+t+"]").parent().css("color","gray")},1)}function tcheckgroup_clear_field(e,t){setTimeout(function(){$("form[name="+e+"] [checkgroup="+t+"]").prop("checked",false)},1)}function tcolor_enable_field(e,t){try{setTimeout(function(){$("form[name="+e+"] [name="+t+"]").closest(".color-div").colorpicker("enable");$("form[name="+e+"] [name="+t+"]").removeClass("tfield_disabled")},1)}catch(e){console.log(e)}}function tcolor_disable_field(e,t){try{setTimeout(function(){$("form[name="+e+"] [name="+t+"]").closest(".color-div").colorpicker("disable");$("form[name="+e+"] [name="+t+"]").addClass("tfield_disabled")},1)}catch(e){console.log(e)}}function tcolor_start(e,t,a){var n=0;if(typeof a!="undefined"){$("#"+e).closest(".color-div").colorpicker().on("changeColor",function(e){if(e.timeStamp-n>500){a(e.color);n=e.timeStamp}});$("#"+e).click(function(){$("#"+e).closest(".color-div").colorpicker("show")})}else{$("#"+e).closest(".color-div").colorpicker()}if(t!=="undefined"){$("#"+e).closest(".color-div").width(t)}$(".colorpicker").css("z-index",1e6)}function ticon_enable_field(e,t){try{setTimeout(function(){$("form[name="+e+'] div[name="block_'+t+'"]').remove()},1)}catch(e){console.log(e)}}function ticon_disable_field(e,t){try{input=$("form[name="+e+"] [name="+t+"]").closest(".input-group");setTimeout(function(){$("form[name="+e+'] div[name="block_'+t+'"]').remove()},19);setTimeout(function(){input.prepend('<div name="block_'+t+'" style="position:absolute; width:'+input.width()+"px; height:"+input.height()+'px; background: #c0c0c0; opacity:0.5;"></div>')},20)}catch(e){console.log(e)}}function ticon_start(e,t){if(t){$("#"+e).iconpicker().on("iconpickerUpdated",function(e){t($(this).val())})}else{$("#"+e).iconpicker()}}function tcombo_enable_field(e,t){if(typeof e!="undefined"&&e!=""){form_name_sel='form[name="'+e+'"] '}else{form_name_sel=""}var a='[name="'+t+'"]';if(t.indexOf("[")==-1&&$("#"+t).length>0){var a="#"+t}try{if($(form_name_sel+a).attr("role")=="tcombosearch"){tmultisearch_enable_field(e,t)}else{$(form_name_sel+a).attr("onclick",null);$(form_name_sel+a).css("pointer-events","auto");$(form_name_sel+a).removeClass("tcombo_disabled")}}catch(e){console.log(e)}}function tcombo_disable_field(e,t){if(typeof e!="undefined"&&e!=""){form_name_sel='form[name="'+e+'"] '}else{form_name_sel=""}var a='[name="'+t+'"]';if(t.indexOf("[")==-1&&$("#"+t).length>0){var a="#"+t}try{if($(form_name_sel+a).attr("role")=="tcombosearch"){tmultisearch_disable_field(e,t)}else{$(form_name_sel+a).attr("onclick","return false");$(form_name_sel+a).attr("tabindex","-1");$(form_name_sel+a).css("pointer-events","none");$(form_name_sel+a).addClass("tcombo_disabled")}}catch(e){console.log(e)}}function tcombo_add_option(e,t,a,n){var a=a.replace(/"/g,"");if(typeof e!="undefined"&&e!=""){e='form[name="'+e+'"] '}else{e=""}var i='select[name="'+t+'"]';if(t.indexOf("[")==-1&&$("#"+t).length>0){var i="#"+t}var r=$(e+i).find("optgroup");if(r.length>0){$('<option value="'+a+'">'+n+"</option>").appendTo(r.last())}else{$('<option value="'+a+'">'+n+"</option>").appendTo(e+i)}}function tcombo_create_opt_group(e,t,a){if(typeof e!="undefined"&&e!=""){e='form[name="'+e+'"] '}else{e=""}var n='[name="'+t+'"]';if(t.indexOf("[")==-1&&$("#"+t).length>0){var n="#"+t}$('<optgroup label="'+a+'"></optgroup>').appendTo(e+n)}function tcombo_clear(e,t,a){if(typeof a=="undefined"){a=true}if(typeof e!="undefined"&&e!=""){var e='form[name="'+e+'"] '}else{var e=""}var n='[name="'+t+'"]';if(t.indexOf("[")==-1&&$("#"+t).length>0){var n="#"+t}var t=$(e+n);if(t.attr("role")=="tcombosearch"){if(t.find("option:not(:disabled)").length>0){t.val("").empty().trigger("change.select2")}}else{t.val(false);t.html("")}if(a){if(t.attr("changeaction")){tform_events_hang_exec(t.attr("changeaction"))}}}function tcombo_enable_search(t,e){$(t).removeAttr("onchange");$(t).select2({allowClear:true,placeholder:e,templateResult:function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}},templateSelection:function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}}}).on("change",function(e){new Function($(t).attr("changeaction"))()})}function tdate_enable_field(e,t){try{$("form[name="+e+"] [name="+t+"]").removeClass("tfield_disabled");$("form[name="+e+"] [name="+t+"]").css("pointer-events","auto");$("form[name="+e+"] [name="+t+"]").removeAttr("tabindex");$("form[name="+e+"] [name="+t+"]").attr("readonly",false)}catch(e){console.log(e)}setTimeout(function(){$("form[name="+e+"] [name="+t+"]").next().show()},1)}function tdate_disable_field(e,t){try{$("form[name="+e+"] [name="+t+"]").addClass("tfield_disabled");$("form[name="+e+"] [name="+t+"]").css("pointer-events","none");$("form[name="+e+"] [name="+t+"]").attr("tabindex","-1");$("form[name="+e+"] [name="+t+"]").attr("readonly",true)}catch(e){console.log(e)}setTimeout(function(){$("form[name="+e+"] [name="+t+"]").next().hide()},1)}function tdate_start(t,e,a,n,i){$(t).wrap('<div class="tdate-group date">');$(t).after('<span class="btn btn-default tdate-group-addon"><i class="far fa-calendar"></i></span>');var r={format:e,todayBtn:"linked",language:a,calendarWeeks:false,autoclose:true,todayHighlight:true,orientation:"bottom auto"};i=Object.assign(r,JSON.parse(i));$(t).closest(".tdate-group").datepicker(i).on("changeDate",function(e){if($(t).attr("exitaction")){new Function($(t).attr("exitaction"))()}}).on("show",function(){$(".datepicker").on("click",function(e){e.stopPropagation()})});if(n!=="undefined"){$(t).closest(".tdate-group").width(n)}}function tdatetime_start(t,e,a,n,i){$(t).wrap('<div class="tdate-group tdatetimepicker input-append date">');$(t).after('<span class="add-on btn btn-default tdate-group-addon"><i class="far fa-clock icon-th"></i></span>');atributes={autoclose:true,todayBtn:true,todayHighlight:true,format:e,language:a};i=Object.assign(atributes,JSON.parse(i));$(t).closest(".tdate-group").datetimepicker(i).on("change.dp",function(e){if($(t).attr("exitaction")){new Function($(t).attr("exitaction"))()}}).on("show",function(){$(".datepicker").on("click",function(e){e.stopPropagation()})});if(n!=="undefined"){$(t).closest(".tdate-group").width(n)}}function tdbentry_start(e,t,a){$('input[name="'+e+'"]').autocomplete({serviceUrl:t,minChars:a})}function tentry_new_mask(t,a){$(document).ready(function(){a=a.replace(/9/g,"0");var e=$("#"+t).attr("maxlength")>0?$("#"+t).attr("maxlength"):250;if(a=="A!"){a="A".repeat(e)}else if(a=="S!"){a="S".repeat(e)}else if(a=="0!"){a="0".repeat(e)}$("#"+t).mask(a)})}function tentry_mask(e,t,a){var n,i,r,o,s,l;n=e.value;if(typeof n=="undefined"){return true}if($(e).attr("forceupper")=="1"){n=n.toUpperCase()}if($(e).attr("forcelower")=="1"){n=n.toLowerCase()}if(document.all){keyCode=t.keyCode}else if(document.layers){keyCode=t.which}else{keyCode=t.which}if(keyCode==8||t.keyCode==9||t.keyCode==13){return true}o="";var c=0;if(a.charAt(1)=="!"){l=e.value.length+1}else{l=a.length}for(i=0;i<l-1;i++){maskChar=a.charAt(i);valueChar=n.charAt(c);if(i<=n.length){if((maskChar=="-"||maskChar=="_"||maskChar=="."||maskChar=="/"||maskChar=="\\"||maskChar==":"||maskChar=="|"||maskChar=="("||maskChar==")"||maskChar=="["||maskChar=="]"||maskChar=="{"||maskChar=="}")&maskChar!==valueChar){o+=maskChar}else{o+=valueChar;c++}}}e.value=o;s=e.value.length;if(a.charAt(1)=="!"){maskChar=a.charAt(0)}else{maskChar=a.charAt(s)}switch(maskChar){case"A":case"a":return keyCode>47&&keyCode<58||keyCode>64&&keyCode<91||keyCode>96&&keyCode<123;break;case"S":case"s":return keyCode>64&&keyCode<91||keyCode>96&&keyCode<123;break;case"9":return keyCode>47&&keyCode<58;break}return true}function tentry_upper(e){if(typeof e.value!=="undefined"){e.value=e.value.toUpperCase()}}function tentry_lower(e){if(typeof e.value!=="undefined"){e.value=e.value.toLowerCase()}}function tentry_autocomplete(e,t,a){var n;var i='input[name="'+e+'"]';if($("#"+e).length>0){var i="#"+e}var r={lookup:t,onSelect:function(){var e=$(this).data("val");var t=$(this).val();$(this).data("val",t);$(i).removeAttr("onblur");if(e!==t){if($(i).attr("exitaction")){string_callback=$(i).attr("exitaction");Function(string_callback)()}}}};a=Object.assign(r,JSON.parse(a));$(i).autocomplete(a)}function tentry_autocomplete_by_name(e,t,a){objectId=$("[name="+e+"]").attr("id");tentry_autocomplete(objectId,t,a)}function tentry_numeric_mask(e,t,a,n,i){var r='input[name="'+e+'"]';if($("#"+e).length>0){var r="#"+e}$(r).maskMoney({prefix:"",suffix:"",affixesStay:true,thousands:n,decimal:a,precision:t,allowZero:true,allowNegative:true,formatOnBlur:i,reverse:i,bringCaretAtEndOnFocus:!i,selectAllOnFocus:false,allowEmpty:true})}function tentry_get_data_by_id(e){var t=$("#"+e).data("nmask");if(typeof t!=="undefined"){var a=t.substring(1,2);var n=t.substring(2,3);var i=$("#"+e).val();i=i.split(n).join("");i=i.split(a).join(".");return i}else{return $("#"+e).val()}}function tentry_exit_on_enter(t){$("#"+t).bind("keypress",function(e){if(e.keyCode==13){document.getElementById(t).blur()}})}function texpander_start(){$(".texpander-container").click(function(e){e.stopPropagation()})}function tfield_enable_field(e,t){try{$("form[name="+e+"] [name="+t+"]").attr("readonly",false);$("form[name="+e+"] [name="+t+"]").removeClass("tfield_disabled")}catch(e){console.log(e)}}function tfield_disable_field(e,t){try{$("form[name="+e+"] [name="+t+"]").attr("readonly",true);$("form[name="+e+"] [name="+t+"]").addClass("tfield_disabled")}catch(e){console.log(e)}}function tfield_clear_field(e,t){try{$("form[name="+e+"] [name="+t+"]").val("")}catch(e){console.log(e)}}function tfield_transfer_value(e,t,a){if($(e).attr("type")=="checkbox"){var n=$(e).attr("value");var i=$(e).closest(a).find(t).val();if($(e).is(":checked")){i=i+n+","}else{i=i.replace(n+",","")}$(e).closest(a).find(t).val(i)}else{var i=$(e).val();$(e).closest(a).find(t).val(i)}}function ttreeview_start(e,t){$(e).treeview({persist:"location",animated:"fast",collapsed:t})}function FileUploader(e,t,a,n,i,r,o,s){this.field_name=$("#"+e).attr("receiver");this.input_id=e;this.service_action=a;this.parent_container=$("#"+t);this.complete_action=n;this.error_action=i;this.file_handling=r;this.image_gallery=JSON.parse(o);this.popover=JSON.parse(s);this.obj_file=document.getElementById(this.input_id);var c=this;this.createStatusRow=function(){var e=c.parent_container.find("[widget=tfile]")[0];var t=$(e).css("width");var a=$("<div />",{class:"tfile_row_wrapper",style:"display:none"});var n=$("<div />",{class:"tfile_row_1"});var i=$("<div />",{class:"tfile_row_2"});var r=$("<div />",{class:"tfile_link_wrapper",style:"width: calc("+t+" - 25px)"});var o=$("<span />",{class:"tfile_del_icon fa fa-minus-circle gray",title:"Remover"});var s=$("<div />",{class:"progress-bar progress-bar-success",style:"width: 0%; height: 2px;"});var l=$("<input />",{type:"hidden",name:c.field_name,widget:"tfile"});if(c.image_gallery.enabled=="1"){$(r).css("width","unset");$(a).css("border","1px solid gray");$(a).css("border-radius","3px");$(a).css("margin","2px")}c.file_row_wrapper=a;c.file_input_hidden=l;c.file_progress_bar=s;c.file_link_wrapper=r;c.parent_container.children(".tfile_row_wrapper").remove();c.parent_container.append(a);a.append(n);a.append(i);n.append(l,r,o);i.append(s);$(o).click(function(){var e=c.getData();a.hide();c.parent_container.children("i").attr({class:"",title:""});c.parent_container.find("[widget=tfile]").css("padding-left","5px");e.delFile=e.fileName;if(e.delFile==e.newFile){e=""}c.setData(e)});return a};this.clear=function(){c.file_row_wrapper.hide();c.parent_container.children("i").attr({class:"",title:""});c.parent_container.find("[widget=tfile]").css("padding-left","5px");$(c.file_input_hidden).val("");$("#"+this.input_id).val("")};this.showFile=function(e){if(typeof e=="undefined"){var e=this.getData()}var t=e.fileName;if(t){var a=c.file_row_wrapper;var n=a.find(".tfile_link_wrapper");a.find(".progress-bar").css("width","100%");if($.inArray(t.split(".").pop(),["png","jpg","jpeg","gif"])>-1){var i='<div class="popover" role="tooltip" style="z-index:100000;max-width:800px"><div class="arrow"></div><h3 class="popover-title popover-header"></h3><div class="popover-content popover-body"><div class="data-content"></div></div></div>';var r='<img style="max-width:460px" src="download.php?file={file_name}">';if(c.popover.content){r=atob(c.popover.content)}r=r.replace("{file_name}",t);if(c.image_gallery.enabled=="1"){var o=$("<a />",{href:"download.php?file="+t,target:"_blank"});var s=$("<img />",{src:"download.php?file="+t}).height(c.image_gallery.height).width(c.image_gallery.width);o.append(s);if(c.popover.enabled=="1"){o.popover({trigger:"hover",content:r,html:true,container:"body",template:i,title:c.popover.title||""})}}else{var o=$("<a />",{href:"download.php?file="+t,target:"_blank"});if(c.popover.enabled=="1"){o.popover({trigger:"hover",content:r,html:true,container:"body",template:i,title:c.popover.title||""})}}}else{var o=$("<a />",{href:"download.php?file="+t,target:"_blank"})}c.file_row_wrapper.show();if(c.image_gallery.enabled!="1"){o.append(t)}n.html(o)}};this.getData=function(){var e=decodeURIComponent(c.file_input_hidden.val());var t="";try{t=e?JSON.parse(e):{}}catch(e){t={}}return t};this.setData=function(e){c.clear();if(e){$(c.file_input_hidden).val(encodeURIComponent(JSON.stringify(e)))}};this.supportAjaxUploadWithProgress=function(){return this.supportFileAPI()&&this.supportAjaxUploadProgressEvents()&&this.supportFormData()};this.supportFileAPI=function(){var e=document.createElement("INPUT");e.type="file";return"files"in e};this.supportAjaxUploadProgressEvents=function(){var e=new XMLHttpRequest;return!!(e&&"upload"in e&&"onprogress"in e.upload)};this.supportFormData=function(){return!!window.FormData};this.initFileUpload=function(){if(c.file_handling){}if(this.supportAjaxUploadWithProgress()){var e=new FormData;var t=c.obj_file.files[0];e.append("fileName",t);this.sendXHRequest(e,c.service_action)}};this.sendXHRequest=function(e,t){var a=new XMLHttpRequest;a.upload.addEventListener("loadstart",this.onLoadStart,false);a.upload.addEventListener("progress",this.onProgress,false);a.upload.addEventListener("load",this.onLoad,false);a.addEventListener("readystatechange",this.onReadyStateChange,false);a.open("POST",t,true);a.send(e)};this.onLoadStart=function(e){if(c.parent_container.children("i").length==0){c.parent_container.prepend($("<i>"))}if(c.file_handling){c.file_row_wrapper.show()}c.parent_container.find("[widget=tfile]").css("padding-left","20px");c.parent_container.children("i").attr({class:"fa fa-spinner fa-spin fa-fw blue file-response-icon",title:"..."})};this.onLoad=function(e){};this.onProgress=function(e){if(e.lengthComputable&&c.file_handling){var t=Math.round(e.loaded*100/e.total);c.file_progress_bar.css("width",t+"%").css("height",2);c.file_link_wrapper.html(t+"%")}};this.onReadyStateChange=function(t){var e=null;try{e=t.target.status}catch(e){return}if(e=="200"&&t.target.readyState=="4"&&t.target.responseText){try{var a=JSON.parse(t.target.responseText);if(a.type=="success"){if(c.file_handling){var n=c.getData();if(n.fileName){n.delFile=n.fileName}n.newFile="tmp/"+a.fileName;n.fileName="tmp/"+a.fileName;c.setData(n);c.showFile(n)}else{var i=$("#"+c.input_id).parent().children("input[type=hidden]");$(i).val(a.fileName)}c.showMessage("success","Sucesso");if(this.readyState==4&&typeof c.complete_action=="function"){c.complete_action()}}else{if(c.file_handling){c.file_row_wrapper.remove()}if(typeof c.error_action=="function"){c.error_action()}c.showMessage("error",a.msg)}}catch(e){if(typeof c.error_action=="function"){c.error_action()}if(c.file_handling){c.file_row_wrapper.remove()}if(typeof a=="undefined"){c.showMessage("error",t.target.responseText)}else{c.showMessage("error",e)}}}};this.showMessage=function(e,t){if(e=="success"){c.parent_container.find("[widget=tfile]").css("padding-left","20px");c.parent_container.children("i").attr({class:"far fa-check-circle green file-response-icon",title:t})}else if(e=="error"){c.parent_container.find("[widget=tfile]").css("padding-left","20px");c.parent_container.children("i").attr({class:"fa fa-exclamation-circle red file-response-icon",title:t});__adianti_error("Error",t)}};this.setValue=function(e){this.clear();if(e){var t={fileName:e};if(e.indexOf("%7B%")>=0){t=JSON.parse(decodeURIComponent(e))}this.setData(t)}this.showFile()}}function tfile_start(a,n,i,r,o,s,l,c){$(function(){var e=new FileUploader(a,n,i,r,o,s,l,c);$("#"+a).change(function(){e.initFileUpload()});if(s){var t=$("#"+a).parent().children("input[type=hidden]");e.createStatusRow();if($(t).val()){e.setData(JSON.parse(decodeURIComponent($(t).val())))}e.showFile();$(t).remove()}$('[name="'+e.field_name+'"]')[0].tfile=e})}function tfile_send_data(e,t){if(t){var a={fileName:t};var n=$("#"+e).data("instance");if(typeof n!="undefined"){n.setData(a);n.showFile()}}}function tfile_enable_field(e,t){try{$("form[name="+e+"] [name=file_"+t+"]").removeAttr("disabled");$("form[name="+e+"] [name=file_"+t+"]").removeClass("tfield_disabled").addClass("tfield")}catch(e){console.log(e)}}function tfile_disable_field(e,t){try{$("form[name="+e+"] [name=file_"+t+"]").attr("disabled",true);$("form[name="+e+"] [name=file_"+t+"]").removeClass("tfield").addClass("tfield_disabled")}catch(e){console.log(e)}}function tfile_clear_field(e,t){try{$("form[name="+e+"] [name="+t+"]").val("");$("form[name="+e+"] [name=file_"+t+"]").val("")}catch(e){console.log(e)}}function tfile_update_download_link(e){if($("#view_"+e).length){value=$("[name="+e+"]").val();$("#view_"+e).attr("href","download.php?file=tmp/"+value);$("#view_"+e).html("tmp/"+value)}}function MultiFileUploader(c,e,t,a,n,i,r,o){this.field_name=$("#"+c).attr("receiver");this.obj_file=e;this.service_action=t;this.complete_action=n;this.file_handling=i;this.image_gallery=JSON.parse(r);this.popover=JSON.parse(o);this.parent_container=$("#"+a);this.instances=[];var d=this;this.createStatusRow=function(){var e=d.parent_container.find("[widget=tmultifile]")[0];var t=$(e).css("width");var a=$("<div />",{class:"tfile_row_wrapper tfile_row_wrapper-"+c});var n=$("<div />",{class:"tfile_row_1"});var i=$("<div />",{class:"tfile_row_2"});var r=$("<div />",{class:"tfile_link_wrapper",style:"width: calc("+t+" - 25px)"});var o=$("<span />",{class:"tfile_del_icon fa fa-minus-circle gray",title:"Remover"});var s=$("<div />",{class:"progress-bar progress-bar-success",style:"width: 0%; height: 2px;"});var l=$("<input />",{type:"hidden",name:d.field_name+"[]"});if(d.image_gallery.enabled=="1"){$(r).css("width","unset");$(a).css("border","1px solid gray");$(a).css("border-radius","3px");$(a).css("margin","2px");$(a).css("display","inline-block")}d.file_row_wrapper=a;d.file_input_hidden=l;d.file_progress_bar=s;d.file_link_wrapper=r;d.parent_container.append(a);a.append(n);a.append(i);n.append(l,r,o);i.append(s);$(o).click(function(){var e=d.getData();a.hide();d.parent_container.children("i").attr({class:"",title:""});d.parent_container.find("[widget=tmultifile]").css("padding-left","5px");e.delFile=e.fileName;if(e.delFile==e.newFile){e="";d.setData(e);a.remove()}d.setData(e)});return a};this.createInputHidden=function(e){var t=$("<input />",{type:"hidden",name:d.field_name+"[]",widget:"thidden",value:e});d.parent_container.append(t);return t};this.showFile=function(e){if(typeof e=="undefined"){var e=this.getData()}var t=e.fileName;if(t){var a=d.file_row_wrapper;var n=a.find(".tfile_link_wrapper");a.find(".progress-bar").css("width","100%");if($.inArray(t.split(".").pop(),["png","jpg","gif","jpeg"])>-1){var i='<div class="popover" role="tooltip" style="z-index:100000;max-width:800px"><div class="arrow"></div><h3 class="popover-title popover-header"></h3><div class="popover-content popover-body"><div class="data-content"></div></div></div>';var r='<img style="max-width:460px" src="download.php?file={file_name}">';if(d.popover.content){r=atob(d.popover.content)}r=r.replace("{file_name}",t);if(d.image_gallery.enabled=="1"){var o=$("<a />",{href:"download.php?file="+t,target:"_blank"});var s=$("<img />",{src:"download.php?file="+t}).height(d.image_gallery.height).width(d.image_gallery.width);o.append(s);if(d.popover.enabled=="1"){n.popover({trigger:"hover",content:r,html:true,container:"body",template:i,title:d.popover.title||""})}}else{var o=$("<a />",{href:"download.php?file="+t,target:"_blank"});if(d.popover.enabled=="1"){o.popover({trigger:"hover",content:r,html:true,container:"body",template:i,title:d.popover.title||""})}}}else{var o=$("<a />",{href:"download.php?file="+t,target:"_blank"})}if(d.image_gallery.enabled!="1"){o.append(t)}n.html(o)}};this.getData=function(){var e=decodeURIComponent(d.file_input_hidden.val());var t="";try{t=e?JSON.parse(e):{}}catch(e){t={}}return t};this.setData=function(e){if(e){$(d.file_input_hidden).val(encodeURIComponent(JSON.stringify(e)))}else{$(d.file_input_hidden).val("")}};this.supportAjaxUploadWithProgress=function(){return this.supportFileAPI()&&this.supportAjaxUploadProgressEvents()&&this.supportFormData()};this.supportFileAPI=function(){var e=document.createElement("INPUT");e.type="file";return"files"in e};this.supportAjaxUploadProgressEvents=function(){var e=new XMLHttpRequest;return!!(e&&"upload"in e&&"onprogress"in e.upload)};this.supportFormData=function(){return!!window.FormData};this.initFileUpload=function(){this.createStatusRow();if(this.supportAjaxUploadWithProgress()){var e=new FormData;var t=d.obj_file;e.append("fileName",t);this.sendXHRequest(e,d.service_action)}};this.sendXHRequest=function(e,t){var a=new XMLHttpRequest;a.upload.addEventListener("loadstart",this.onLoadStart,false);a.upload.addEventListener("progress",this.onProgress,false);a.upload.addEventListener("load",this.onLoad,false);a.addEventListener("readystatechange",this.onReadyStateChange,false);a.open("POST",t,true);a.send(e)};this.onLoadStart=function(e){if(d.parent_container.children("i").length==0){d.parent_container.prepend($("<i>"))}d.parent_container.find("[widget=tmultifile]").css("padding-left","20px");d.parent_container.children("i").attr({class:"fa fa-spinner fa-spin fa-fw blue file-response-icon",title:"..."})};this.onLoad=function(e){};this.onProgress=function(e){if(e.lengthComputable){var t=Math.round(e.loaded*100/e.total);d.file_progress_bar.css("width",t+"%").css("height",2);d.file_link_wrapper.html(t+"%")}};this.onReadyStateChange=function(t){var e=null;try{e=t.target.status}catch(e){return}if(e=="200"&&t.target.readyState=="4"&&t.target.responseText){try{var a=JSON.parse(t.target.responseText);if(a.type=="success"){if(d.file_handling){var n=d.getData();n.newFile="tmp/"+a.fileName;n.fileName="tmp/"+a.fileName;d.setData(n);d.showFile(n)}else{d.file_input_hidden.val(a.fileName);d.file_link_wrapper.html(a.fileName)}d.showMessage("success","Sucesso");if(this.readyState==4&&typeof d.complete_action=="function"){d.complete_action()}}else{d.file_row_wrapper.remove();d.showMessage("error",a.msg)}}catch(e){d.file_row_wrapper.remove();if(typeof a=="undefined"){d.showMessage("error",t.target.responseText)}else{d.showMessage("error",e)}}}};this.showMessage=function(e,t){if(e=="success"){d.parent_container.find("[widget=tmultifile]").css("padding-left","20px");d.parent_container.children("i").attr({class:"far fa-check-circle green file-response-icon",title:t})}else if(e=="error"){d.parent_container.find("[widget=tmultifile]").css("padding-left","20px");d.parent_container.children("i").attr({class:"fa fa-exclamation-circle red file-response-icon",title:t})}};this.clear=function(){$(".tfile_row_wrapper-"+c).each(function(){$(this).find("input").each(function(){$(this).val("")});$(this).remove()});d.parent_container.children("i").attr({class:"",title:""});d.parent_container.find("[widget=tmultifile]").css("padding-left","5px");$('[name="file_'+this.field_name+'[]"]').val("");$(this.file_input_hidden).val("");$("#"+this.input_id).val("")};this.setValue=function(e){this.clear();if(!e){return}try{e=JSON.parse(e)}catch(e){}for(var t in e){var a=e[t];var n={idFile:t,fileName:a};if(a.indexOf("%7B%")>=0){n=JSON.parse(decodeURIComponent(a))}if(this.file_handling){this.createStatusRow();this.setData(n);this.showFile()}else{this.createInputHidden(a)}}};this.addInstance=function(e){this.instances.push(e)}}function tmultifile_start(n,i,r,o,s,l,c){var d=new MultiFileUploader(n,null,r,i,o,s,l,c);$(function(){$("#"+n).change(function(){$.each($(this).prop("files"),function(e,t){var a=new MultiFileUploader(n,t,r,i,o,s,l,c);a.initFileUpload();d.addInstance(a)})});if(s){$("#"+n).parent().children("input[type=hidden]").each(function(e,t){var a=new MultiFileUploader(n,null,r,i,o,s,l,c);a.createStatusRow();if($(t).val()){a.setData(JSON.parse(decodeURIComponent($(t).val())))}a.showFile();$(t).remove();d.addInstance(a)})}$("#"+n)[0].tmultifile=d})}function tmultifile_enable_field(e,t){try{$("form[name="+e+"] [name='file_"+t+"[]']").removeAttr("disabled");$("form[name="+e+"] [name='file_"+t+"[]']").removeClass("tfield_disabled").addClass("tfield")}catch(e){console.log(e)}}function tmultifile_disable_field(e,t){try{$("form[name="+e+"] [name='file_"+t+"[]']").attr("disabled",true);$("form[name="+e+"] [name='file_"+t+"[]']").removeClass("tfield").addClass("tfield_disabled")}catch(e){console.log(e)}}function tmultifile_clear_field(e,t){try{$("form[name="+e+"] [name='"+t+"[]']").val("");$("form[name="+e+"] [name='file_"+t+"[]']").val("")}catch(e){console.log(e)}}function thtmleditor_enable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").next().find(".note-editable").attr("contenteditable",true)},1)}function thtmleditor_disable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").next().find(".note-editable").attr("contenteditable",false)},1)}function thtmleditor_clear_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").code("")},1)}function thtmleditor_start(a,e,t,n,i){var r={fontSizes:["8","9","10","11","12","14","18","24","36","48","64","82","150"],width:e,height:t,lang:n,toolbar:[["undoredo",["undo","redo"]],["style",["style","bold","italic","underline","clear"]],["font",["fontname","fontsize","color"]],["para",["ul","ol","paragraph","height"]],["insert",["table","link","picture","hr"]],["view",["fullscreen","codeview","help"]]]};i=Object.assign(r,JSON.parse(i));if(typeof i.completion!=="undefined"){if(typeof summernote_wordlist=="undefined"){summernote_wordlist={}}summernote_wordlist[a]=i.completion;i.hint={match:/\b(\w{1,})$/,search:function(t,e){e($.grep(summernote_wordlist[a],function(e){return e.indexOf(t)===0}))}}}if(i.airMode==true){setTimeout(function(){$("#"+a).parent().find(".note-editable").height(t+"px").css("overflow","auto")},1)}$("#"+a).summernote(i);if(typeof $("#"+a).next(".note-editor")[0]!=="undefined"){var o=$("#"+a).next(".note-editor")[0];$(o).css("margin",$("#"+a).css("margin"))}}function thtml_editor_reload_completion(e,t){objectId=$("[name="+e+"]").attr("id");setTimeout(function(){summernote_wordlist[objectId]=t},1)}function tmenubar_start(){$(document).ready(function(){$(".dropdown-toggle").dropdown()})}function tmultisearch_start(e,t,a,n,i,r,o,s,l,c){var d={minimumInputLength:t,maximumSelectionLength:a,allowClear:s,placeholder:n,multiple:i,minimumResultsForSearch:l,id:function(e){return e.id+"::"+e.text},templateResult:function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}},templateSelection:function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}}};if(i!=="1"){delete d.maximumSelectionLength}$("#"+e).select2(d).on("select2:unselecting",function(){$(this).data("unselecting",true)}).on("select2:opening",function(e){if($(this).data("unselecting")){$(this).removeData("unselecting");e.preventDefault()}});if(typeof c!="undefined"){$("#"+e).on("change",function(e){c()})}if(parseInt(a)!==1){$("#"+e).parent().find(".select2-selection").height(o);$("#"+e).parent().find(".select2-selection").find(".select2-selection__rendered").height(o);$("#"+e).parent().find(".select2-selection").find(".select2-selection__rendered").css("overflow-y","auto")}}function tmultisearch_clear_field(e,t){try{$("form[name="+e+'] [name="'+t+'[]"]').val("").trigger("change");$("form[name="+e+'] [name="'+t+'"]').val("").trigger("change")}catch(e){console.log(e)}}function tmultisearch_enable_field(e,t){try{if($("form[name="+e+'] [name="'+t+'"]').length>0){$("form[name="+e+'] [name="'+t+'"]').next(".select2").find(".select2-disable").remove()}else{$("form[name="+e+'] [name="'+t+'[]"]').next(".select2").find(".select2-disable").remove()}}catch(e){console.log(e)}}function tmultisearch_disable_field(e,t){try{if($("form[name="+e+'] [name="'+t+'"]').length>0){$("form[name="+e+'] [name="'+t+'"]').next(".select2").prepend('<div class="select2-disable"></div>')}else{$("form[name="+e+'] [name="'+t+'[]"]').next(".select2").prepend('<div class="select2-disable"></div>')}}catch(e){console.log(e)}}$.fn.select2.amd.require(["select2/selection/search"],function(e){var t=e.prototype.searchRemoveChoice;e.prototype.searchRemoveChoice=function(){t.apply(this,arguments);this.$search.val("")}});$.fn.select2.amd.require(["select2/selection/single"],function(e){var a=e.prototype.update;e.prototype.update=function(e){a.apply(this,Array.prototype.slice.apply(arguments));var t=this.$selection.find(".select2-selection__rendered");t.removeAttr("title")}});$.fn.select2.amd.require(["select2/selection/multiple"],function(e){var n=e.prototype.update;e.prototype.update=function(e){n.apply(this,Array.prototype.slice.apply(arguments));var t=this.options.get("selectionTitleAttribute");if(t===false){var a=this.$selection.find(".select2-selection__rendered");a.find(".select2-selection__choice").removeAttr("title")}}});function tmultientry_start(e,t,a,n,i){var r={tags:true,maximumSelectionLength:t,width:a,height:n,tokenSeparators:[",",";"]};if(typeof i!="undefined"){$("#"+e).on("change",function(e){i()})}var o=$("#"+e).select2(r);$("#"+e).parent().find(".select2-selection").height(n);$("#"+e).parent().find(".select2-selection").find(".select2-selection__rendered").height(n);$("#"+e).parent().find(".select2-selection").find(".select2-selection__rendered").css("overflow-y","auto")}function tdbuniquesearch_set_value(e,a,i,r){setTimeout(function(){if(a.substr(0,1)=="#"){var n=$(a)}else{var n=$("[name="+a+"]")}var e=n.data("select2").options.options.hash;var t=n.data("select2").options.options.ajax.url+"&hash="+e+"&value="+i+"&onlyidsearch=1";$.ajax({url:t,dataType:"json"}).done(function(e){if(Array.isArray(e.result)){if(e.result.length>0){var t=e.result[0];var a=t.split("::");if(!n.find("option[value='"+a[0]+"']").length){n.append(new Option(a[1],a[0],true,true))}if(i==""){n.val("").trigger("change.select2")}else{var e=[];e.push(a[0]);n.val(e).trigger("change.select2")}if(typeof r=="function"){r()}}else{n.val("").trigger("change.select2")}}else{n.val("").trigger("change.select2")}}).fail(function(e,t,a){__adianti_error("Error",t+": "+"connection failed")})},1)}function tdbmultisearch_start(e,t,a,n,i,r,o,s,l,c){var d={minimumInputLength:t,maximumSelectionLength:a,allowClear:true,placeholder:n,multiple:i,hash:l,id:function(e){return e.id+"::"+e.text},templateResult:function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}},templateSelection:function(e){if(/<[a-z][\s\S]*>/i.test(e.text)){return $("<span>"+e.text+"</span>")}else{return e.text}},ajax:{url:r,dataType:"json",delay:250,data:function(e,t){return{value:e.term,hash:l}},processResults:function(e,t){var a=[];$(e.result).each(function(e){var t=this.split("::");a.push({id:t[0],text:t[1]})});return{results:a}}}};if(i!=="1"){delete d.maximumSelectionLength}$("#"+e).select2(d).on("select2:unselecting",function(){$(this).data("unselecting",true)}).on("select2:opening",function(e){if($(this).data("unselecting")){$(this).removeData("unselecting");e.preventDefault()}});if(typeof c!="undefined"){$("#"+e).on("change",function(e){c()})}if(parseInt(a)!==1){$("#"+e).parent().find(".select2-selection").height(s);$("#"+e).parent().find(".select2-selection").find(".select2-selection__rendered").height(s);$("#"+e).parent().find(".select2-selection").find(".select2-selection__rendered").css("overflow-y","auto")}}function tradiogroup_enable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").attr("onclick",null);$("form[name="+e+"] [name="+t+"]").css("pointer-events","auto");$("form[name="+e+"] [name="+t+"]").parent().css("pointer-events","auto");$("form[name="+e+"] [name="+t+"]").parent().removeAttr("disabled");$("form[name="+e+"] [name="+t+"]").parent().css("color","")},1)}function tradiogroup_disable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").attr("onclick","return false");$("form[name="+e+"] [name="+t+"]").css("pointer-events","none");$("form[name="+e+"] [name="+t+"]").parent().css("pointer-events","none");$("form[name="+e+"] [name="+t+"]").parent().attr("disabled","");$("form[name="+e+"] [name="+t+"]").parent().css("color","gray")},1)}function tradiogroup_clear_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").attr("checked",false)},1)}function tseekbutton_enable_field(e,t){try{$("form[name="+e+"] [name="+t+"]").attr("disabled",false);$("form[name="+e+"] [name="+t+"]").removeClass("tfield_disabled").addClass("tseekentry")}catch(e){console.log(e)}setTimeout(function(){$("form[name="+e+"] [for="+t+"]").show()},1)}function tseekbutton_disable_field(e,t){try{$("form[name="+e+"] [name="+t+"]").attr("disabled",true);$("form[name="+e+"] [name="+t+"]").addClass("tfield_disabled").removeClass("tseekentry")}catch(e){console.log(e)}setTimeout(function(){$("form[name="+e+"] [for="+t+"]").hide()},1)}function tselect_enable_field(e,t){try{$("form[name="+e+'] [name="'+t+'[]"]').attr("disabled",false);$("form[name="+e+'] [name="'+t+'[]"]').removeClass("tcombo_disabled").addClass("tcombo")}catch(e){console.log(e)}}function tselect_disable_field(e,t){try{$("form[name="+e+'] [name="'+t+'[]"]').attr("disabled",true);$("form[name="+e+'] [name="'+t+'[]"]').removeClass("tcombo").addClass("tcombo_disabled")}catch(e){console.log(e)}}function tselect_clear_field(e,t){try{$("form[name="+e+'] [name="'+t+'[]"]').val("")}catch(e){console.log(e)}}function tselect_add_option(e,t,a,n){$('<option value="'+a+'">'+n+"</option>").appendTo('form[name="'+e+'"] select[name="'+t+'[]"]')}function tselect_clear(e,t){$('form[name="'+e+'"] select[name="'+t+'[]"]').html("")}function tslider_start(e,t,a,n,i){var t=$(e).val();$(e).wrap('<div class="tslidercontainer">');$(e).before('<div class="label">'+t+"</div>");$(e).on("input",function(){$(e).parent().find(".label").html(this.value)})}function tslider_enable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").css("pointer-events","auto");$("form[name="+e+"] [name="+t+"]").removeClass("tfield_disabled")},1)}function tslider_disable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").css("pointer-events","none");$("form[name="+e+"] [name="+t+"]").addClass("tfield_disabled")},1)}function tsortlist_start(e,t,a,i){$(e).sortable({connectWith:t,tolerance:"pointer",start:function(e,t){t.item.data("index",t.item.index());t.item.data("parenta",this.id)},receive:function(e,t){if(i>0){if($(this).children().length>i){$(t.sender).sortable("cancel");return}}var a=t.sender;var n=$(this);targetListName=this.getAttribute("itemname");document.getElementById(t.item.attr("id")+"_input").name=targetListName+"[]";if(t.item.css("display")!==n.attr("itemdisplay")){t.item.css("display",n.attr("itemdisplay"));detached=t.item.detach();$(n).append(detached)}},deactivate:a}).disableSelection()}function tsortlist_enable_field(e,t){setTimeout(function(){$("form[name="+e+"] [itemname="+t+"]").sortable("enable")},1)}function tsortlist_disable_field(e,t){setTimeout(function(){$("form[name="+e+"] [itemname="+t+"]").sortable("disable")},1)}function tsortlist_clear_field(e,t){setTimeout(function(){$("form[name="+e+"] [itemname="+t+"]").empty()},1)}function tspinner_start(n,i){$(n).wrap('<div class="input-group spinner" data-trigger="spinner">');$(n).after('<div class="input-group-addon"> <a href="javascript:;" class="spin-up" data-spin="up"><i class="fa fa-caret-up"></i></a> <a href="javascript:;" class="spin-down" data-spin="down"><i class="fa fa-caret-down"></i></a> </div>');$(n).parent().spinner("changing",function(e,t,a){if($(n).attr("exitaction")){new Function($(n).attr("exitaction"))()}if(typeof i=="function"){i()}})}function tspinner_enable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").parent().css("pointer-events","auto");$("form[name="+e+"] [name="+t+"]").removeClass("tfield_disabled");$("form[name="+e+"] [name="+t+"]").removeAttr("readonly")},1)}function tspinner_disable_field(e,t){setTimeout(function(){$("form[name="+e+"] [name="+t+"]").parent().css("pointer-events","none");$("form[name="+e+"] [name="+t+"]").addClass("tfield_disabled");$("form[name="+e+"] [name="+t+"]").attr("readonly",true)},1)}function tfullcalendar_start(e,t,a,n,i,r,o,s,l,c,d,f,u,p,m){var _=0;var h=0;var v={header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay,listWeek"},hiddenDays:f,defaultDate:n,defaultView:a,allDaySlot:false,viewRender:function(e,t){setTimeout(function(){__adianti_process_popover()},100)},minTime:c,maxTime:d,slotLabelFormat:"HH:mm",lang:i,editable:t,eventLimit:true,events:r,eventDurationEditable:p,eventStartEditable:u,eventRender:function(e,t){t.find(".fc-title").html(e.title);t.find(".fc-list-item-title").html(e.title)},dayClick:function(e,t,a){if(o!==""&&_==0&&h==0){__adianti_load_page(o+"&date="+e.format()+"&view="+a.name)}},eventClick:function(e,t,a){if(s!==""&&_==0&&h==0){__adianti_load_page(s+"&id="+e.id+"&key="+e.id+"&view="+a.name)}},eventDragStart:function(e,t,a,n){_=1},eventDragStop:function(e,t,a,n){_=0},eventDrop:function(e,t,a,n){if(l!==""){__adianti_ajax_exec(l+"&id="+e.id+"&key="+e.id+"&start_time="+e.start.format()+"&end_time="+e.end.format())}},eventResizeStart:function(e,t,a,n){h=1},eventResizeStop:function(e,t,a,n){h=0},eventResize:function(e,t,a,n){if(l!==""){__adianti_ajax_exec(l+"&id="+e.id+"&key="+e.id+"&start_time="+e.start.format()+"&end_time="+e.end.format())}},eventAfterAllRender:function(){__adianti_process_popover()}};m=Object.assign(v,JSON.parse(m));$("#"+e).fullCalendar(m)}function ticonview_contextmenu_start(a){$("#"+a).contextmenu(function(e){$(".dropdown-iconview").hide();var t=$("#"+a).next("ul");t.css("left",ticonview_mouseX(e,$("#"+a)));t.css("top",ticonview_mouseY(e,$("#"+a)));t.show();e.preventDefault()});return false}function ticonview_bind_click(){$(document).bind("click",function(e){$(".dropdown-iconview").hide()})}function ticonview_mouseX(e,t){var a=0;if($(t).closest(".ui-dialog").length>0){a=$(t).closest(".ui-dialog").offset().left}if(e.pageX){return e.pageX-a}else if(e.clientX){return e.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft)-a}else{return null}}function ticonview_mouseY(e,t){var a=0;if($(t).closest(".ui-dialog").length>0){a=$(t).closest(".ui-dialog").offset().top+50}if(e.pageY){return e.pageY-a}else if(e.clientY){return e.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop)-a}else{return null}}function ticonview_move_start(e,o,t,a){$("#"+e+" li"+t).draggable({zIndex:1e5,cursor:"pointer",start:function(e,t){$(this).css("opacity",.5);$(this).addClass("iconview-drag")},stop:function(e,t){$(this).css("opacity",1)},revert:function(e,t){$(this).data("uiDraggable").originalPosition={top:0,left:0};return!e}});$("ul.ticonview li"+a).droppable({accept:".iconview-drag",drop:function(e,t){var a=$(t.draggable).data();var n=$(this).data();var i={};for(var r in a){if(a.hasOwnProperty(r)&&(typeof a[r]=="string"||typeof a[r]=="number")){i["source_"+r]=a[r]}}for(var r in n){if(n.hasOwnProperty(r)&&(typeof n[r]=="string"||typeof n[r]=="number")){i["target_"+r]=n[r]}}__adianti_load_page(o+"&"+$.param(i))},over:function(e,t){$(this).addClass("ui-over").addClass($(this).attr("id"))},out:function(e,t){$(this).removeClass("ui-over")}})}function kanban_start_board(e,r){$("#"+e).sortable({revert:200,placeholder:"kanban-stage-placeholder",forcePlaceholderSize:true,helper:function(e,t){return $(t).clone().addClass("kanban-dragging")},start:function(e,t){t.item.show().addClass("kanban-ghost")},stop:function(e,t){t.item.show().removeClass("kanban-ghost")},update:function(e,t){var a=$(t.item).attr("stage_id");var n=[];$(".kanban-stage").each(function(){n.push($(this).attr("stage_id"))});var i=n.join("&order[]=");__adianti_load_page(r+"&key="+a+"&id="+a+"&stage_id="+a+"&order[]="+i)},cursor:"move",tolerance:"pointer",cancel:".kanban-stage-actions, .kanban-item, .kanban-shortcuts"})}function kanban_start_item(e,l){$("."+e).sortable({revert:200,placeholder:"kanban-item-placeholder",forcePlaceholderSize:true,connectWith:".kanban-item-sortable",helper:function(e,t){return $(t).clone().addClass("kanban-dragging")},start:function(e,t){t.item.show().addClass("kanban-ghost")},stop:function(e,t){t.item.show().removeClass("kanban-ghost")},update:function(e,t){if(l&&this===t.item.parent()[0]){var a=$(t.item).attr("item_id");var n=$(this).attr("stage_id");var i=[];$("[stage_id="+n+"] .kanban-item").each(function(){i.push($(this).attr("item_id"))});var r="";var o=i.indexOf(r);if(o!==-1)i.splice(o,1);var s=i.join("&order[]=");__adianti_load_page(l+"&key="+a+"&id="+a+"&stage_id="+n+"&order[]="+s)}},cursor:"move",tolerance:"pointer",cancel:".kanban-item-content, .kanban-item-actions"})}function tchecklist_row_enable_check(e){$("table#"+e+" tbody tr").click(function(e){var t=$(this).find("[type=checkbox]");var a=$(t).prop("checked");$(t).prop("checked",!a);if(!a){$(this).addClass("selected")}else{$(this).removeClass("selected")}});$("table#"+e+" tbody tr input[type=checkbox]").click(function(e){var t=$(this).prop("checked");var a=$(this).closest("tr");if($(this).offset().left<0){$(this).prop("checked",!t);if(!t){$(a).addClass("selected")}else{$(a).removeClass("selected")}}else{if(t){$(a).addClass("selected")}else{$(a).removeClass("selected")}}e.stopPropagation()})}function tchecklist_select_all(n,e){$("table#"+e+" tbody tr:visible td input[type=checkbox]").each(function(e,t){var a=t.closest("tr");if(!n.checked&&t.checked){$(t).prop("checked",false);$(a).removeClass("selected")}else if(n.checked&&!t.checked){$(t).prop("checked",true);$(a).addClass("selected")}})}var tbarcodeinputreader;var tbarcodeinputreader_receive;function tbarcodeinputreader_open_reader(t){var e=t+"_reader";var a=t+"_container";var n=$(window).width()*.9;var i=$(window).height()*.8;var r=document.createElement("div");var o=document.createElement("div");var s=document.createElement("video");r.title="Barcode";r.id=a;s.id=e;o.id=e+"-cameras";r.setAttribute("class","tbarcodeinputreader_container");s.setAttribute("class","tbarcodeinputreader_reader");o.setAttribute("class","tbarcodeinputreader-cameras");r.appendChild(s);r.appendChild(o);$("#adianti_div_content").append(r);tbarcodeinputreader_start(e,function(){tjquerydialog_start("#"+a,true,false,false,n,i,0,0,99999,[],function(){tbarcodeinputreader.closing=true;tbarcodeinputreader_stop()},true,"")},function(e){__adianti_block_ui();$("#"+t).val(e);tbarcodeinputreader_stop();if(typeof $("#"+t).attr("changeaction")!=="undefined"){Function($("#"+t).attr("changeaction"))()}__adianti_unblock_ui()})}function tbarcodeinputreader_start(a,n,e){tbarcodeinputreader=new ZXing.BrowserBarcodeReader;tbarcodeinputreader.closing=false;tbarcodeinputreader._stopContinuousDecode=false;tbarcodeinputreader_receive=e;tbarcodeinputreader.listVideoInputDevices().then(function(e){if(!e||e.length==0){return}n();if(e.length>1){trbarcodeinputreader_make_radio_camera(a,e)}var t=e[e.length-1].deviceId;tbarcodeinputreader_read(t,a)}).catch(function(e){__adianti_error("Error",e)})}function trbarcodeinputreader_make_radio_camera(e,t){for(var a=0;a<t.length;a++){var n=t[a];var i=document.createElement("input");var r=document.createElement("label");i.id=n.deviceId;i.type="radio";i.name=e+"-camera";i.setAttribute("onchange","tbarcodeinputreader_restart('"+n.deviceId+"','"+e+"');");r.for=n.deviceId;r.appendChild(i);r.appendChild(document.createTextNode(n.label));if(a==t.length-1){i.checked=true}$("#"+e+"-cameras").append(r)}}function tbarcodeinputreader_stop(){tbarcodeinputreader_close()}function tbarcodeinputreader_close(){tbarcodeinputreader.reset();$(".tbarcodeinputreader_container").closest(".ui-dialog").remove();$(".tbarcodeinputreader_container").remove()}function tbarcodeinputreader_restart(e,t){tbarcodeinputreader.closing=true;tbarcodeinputreader.reset();tbarcodeinputreader_read(e,t)}function tbarcodeinputreader_read(e,t){tbarcodeinputreader.decodeOnceFromVideoDevice(e,t).then(function(e){tbarcodeinputreader_receive(e)}).catch(function(e){if(tbarcodeinputreader&&tbarcodeinputreader.closing){return}tbarcodeinputreader_close();__adianti_error("Error",e)})}var tqrcodeinputreader;var tqrcodeinputreader_receive;function tqrcodeinputreader_open_reader(t){var e=t+"_reader";var a=t+"_container";var n=$(window).width()*.9;var i=$(window).height()*.8;var r=document.createElement("div");var o=document.createElement("div");var s=document.createElement("div");r.title="QRCode";r.id=a;s.id=e;o.id=e+"-cameras";r.setAttribute("class","tqrcodeinputreader_container");s.setAttribute("class","tqrcodeinputreader_reader");o.setAttribute("class","tqrcodeinputreader-cameras");r.appendChild(s);r.appendChild(o);$("#adianti_div_content").append(r);tqrcodeinputreader_start(e,function(){tjquerydialog_start("#"+a,true,false,false,n,i,0,0,99999,[],tqrcodeinputreader_stop,true,"")},function(e){__adianti_block_ui();$("#"+t).val(e);tqrcodeinputreader_stop();if(typeof $("#"+t).attr("changeaction")!=="undefined"){Function($("#"+t).attr("changeaction"))()}__adianti_unblock_ui()})}function tqrcodeinputreader_start(a,n,e){tqrcodeinputreader=new Html5Qrcode(a);tqrcodeinputreader_receive=e;Html5Qrcode.getCameras().then(function(e){if(!e||e.length==0){return}n();if(e.length>1){trqcodeinputreader_make_radio_camera(a,e)}var t=e[e.length-1].id;tqrcodeinputreader_read(t)}).catch(function(e){__adianti_error("Error",e)})}function trqcodeinputreader_make_radio_camera(e,t){for(var a=0;a<t.length;a++){var n=t[a];var i=document.createElement("input");var r=document.createElement("label");i.id=n.id;i.type="radio";i.name=e+"-camera";i.setAttribute("onchange","tqrcodeinputreader_restart('"+n.id+"');");r.for=n.id;r.appendChild(i);r.appendChild(document.createTextNode(n.label));if(a==t.length-1){i.checked=true}$("#"+e+"-cameras").append(r)}}function tqrcodeinputreader_stop(){if(!tqrcodeinputreader||!tqrcodeinputreader._isScanning){tqrcodeinputreader_close();return}tqrcodeinputreader.stop().then(function(){tqrcodeinputreader_close()}).catch(function(e){__adianti_error("Error",e)})}function tqrcodeinputreader_close(){$(".tqrcodeinputreader_container").closest(".ui-dialog").remove();$(".tqrcodeinputreader_container").remove();tqrcodeinputreader=null}function tqrcodeinputreader_restart(e){tqrcodeinputreader.stop().then(function(){tqrcodeinputreader_read(e)}).catch(function(e){__adianti_error("Error",e)})}function tqrcodeinputreader_read(e){tqrcodeinputreader.start(e,{qrbox:$("#"+tqrcodeinputreader._elementId).width()*.75},function(e){tqrcodeinputreader_receive(e)},function(e){}).catch(function(e){__adianti_error("Error",e)})}var TImageCropper=function(e,t,a,n,i,r,o,s,l,c){this.cropper;this.url;this.name=l;this.type=c;this.fileHandling=i;this.serviceAction=n;this.field=e;this.title=t;this.buttonLabel=a;this.config=s;this.base64=r;this.webcam=o;this.file_input_hidden=$("input[name="+e+"]");this.file=$("#tfile_timagecropper_"+e);this.image=$("#timagecropper_"+e);this.actions=$("#timagecropper_"+e+"+div.timagecropper_actions");this.edit=this.actions.find("[action=edit]");this.remove=this.actions.find("[action=remove]");this.file.click(function(e){if(!o||/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return}e.preventDefault();var a=document.createElement("div");a.id="webcam_"+l.replace(".","");a.title="WebCam";$(a).addClass("timagecropper_webcam");$("#adianti_div_content").append(a);var t=$(window).width()*.75;var n=$(window).height()*.75;Webcam.set({image_format:"png"});Webcam.set("constraints",{});tjquerydialog_start("#"+a.id,true,false,false,t,n,0,0,2050,[{text:"Capturar",click:function(){Webcam.snap(function(e){var t=g(e);d(a.id);m(null,[t])})}}],function(){d(a.id)},true,"");setTimeout(function(){Webcam.attach("#"+a.id)},500)});var d=function(e){Webcam.reset();$("#"+e).remove()};this.dropzone=$("#timagecropper_container_"+e);this.dropzone.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault();e.stopPropagation()});this.dropzone.on("dragover dragenter",function(){$("#timagecropper_container_"+e).addClass("highlight")});this.dropzone.on("dragleave dragend drop",function(){$("#timagecropper_container_"+e).removeClass("highlight")});var f=this;var u=function(e){__adianti_block_ui();f.url=f.image[0].src;v();__adianti_unblock_ui();e.preventDefault()};var p=function(e){var t=$("#timagecropper_"+f.field)[0];if(f.fileHandling){var a=k();a.delFile=a.fileName;a.fileName="";a.newFile="";if(a.delFile==a.newFile){a=""}w(a);t.src=" "}else{var t=$("#timagecropper_"+f.field)[0];f.url=null;t.src=" ";w("")}f.actions.hide();e.preventDefault()};var m=function(e,t){__adianti_block_ui();var a=t||e.target.files||e.originalEvent.dataTransfer.files;if(a&&a.length>0){var n=a[0];f.name=n.name;f.type=n.type;_(n);__adianti_unblock_ui()}else{__adianti_unblock_ui()}};var _=function(e){if(URL){f.url=URL.createObjectURL(e);v()}else if(FileReader){reader=new FileReader;reader.onload=function(e){f.url=reader.result;v()};reader.readAsDataURL(e)}};var h=function(){var e=$("#timgagecropper_image_"+f.field)[0];var t={viewMode:0,highlight:true,rotatable:true,responsive:true,restore:true,modal:true,guides:true};if(f.config.aspectRatio){t.aspectRatio=f.config.aspectRatio}f.cropper=new Cropper(e,t)};var v=function(){__adianti_block_ui();var e=document.createElement("div");var t=document.createElement("div");var a=document.createElement("div");var n=document.createElement("div");var i=document.createElement("img");var r=$(window).width()*.95;var o=$(window).height()*.9;i.src=f.url;i.id="timgagecropper_image_"+f.field;e.title=f.title;e.id="container_timgagecropper_image_"+f.field;a.appendChild(n);t.appendChild(i);t.appendChild(a);e.appendChild(t);if($(window).width()<540){var s=r-30;var l=o-200}else{var s=r-100;var l=o-130}t.setAttribute("style","width: "+s+"px; height: "+l+"px");i.setAttribute("class","img_timagecrroper");t.setAttribute("class","container_timagecrroper");a.setAttribute("class","actions_timagecrroper");a.setAttribute("class","actions_timagecrroper");if(f.config.enableButtonDrag){n.appendChild(T())}if(f.config.enableButtonScale){n.appendChild(C())}if(f.config.enableButtonZoom){n.appendChild(D())}if(f.config.enableButtonRotate){n.appendChild(O())}if(f.config.enableButtonRotate){n.appendChild(x())}$("#adianti_div_content").append(e);tjquerydialog_start("#"+e.id,true,false,false,r,o,0,0,2050,[{text:f.buttonLabel,click:b}],null,true,"");h();__adianti_unblock_ui()};var g=function(e){var t=e.split(",");var a=atob(t[1]);var n=a.length;var i=new Uint8Array(n);while(n--){i[n]=a.charCodeAt(n)}var r=f.name?f.name:"image"+Math.floor(Math.random()*1e6+1)+".png";var o=f.type?f.type:"image/png";return new File([i],r,{type:o})};var b=function(){__adianti_block_ui();var e=f.cropper.getCroppedCanvas({width:f.config.cropWidth,heigth:f.config.cropHeight});var t=e.toDataURL(f.type);$("#timagecropper_"+f.field).attr("src",t);$("#timagecropper_"+f.field).show();f.actions.show();if(f.base64){f.file_input_hidden.val(t)}else{try{var a=g(t);var n=new FormData;n.append("fileName",a);var i=new XMLHttpRequest;i.open("POST",f.serviceAction,true);i.addEventListener("readystatechange",y,false);i.send(n);if(f.fileHandling){var r=k();if(r.fileName&&r.fileName!=r.newFile){r.delFile=r.fileName}r.newFile="tmp/"+f.name;r.fileName="tmp/"+f.name;w(r)}else{f.file_input_hidden.val(f.name)}}catch(e){__adianti_error("Error",e)}}$(".ui-dialog").remove();$("#container_timgagecropper_image_"+f.field).remove();f.cropper.destroy();__adianti_unblock_ui()};var y=function(e){var t=null;try{t=e.target.status}catch(e){return}if(t=="200"&&e.target.readyState=="4"&&e.target.responseText){try{var a=JSON.parse(e.target.responseText);if(a.type=="error"){__adianti_error("Error",a.msg)}}catch(e){__adianti_error("Error",e)}}};var w=function(e){if(e){$(f.file_input_hidden).val(encodeURIComponent(JSON.stringify(e)))}else{$(f.file_input_hidden).val("")}};f.sendData=w;var k=function(){var e=decodeURIComponent(f.file_input_hidden.val());var t="";try{t=e?JSON.parse(e):{}}catch(e){t={}}return t};var x=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-sync-alt");t.setAttribute("title",f.config.labels.reset);t.addEventListener("click",function(){f.cropper.reset()});t.addEventListener("touchstart",function(){f.cropper.reset()});t.appendChild(e);return t};var C=function(){var e=A();var t=E();var a=document.createElement("div");a.appendChild(e);a.appendChild(t);return a};var A=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-arrows-alt-h");t.setAttribute("title",f.config.labels.scalex);t.setAttribute("data-option","-1");t.addEventListener("click",function(){S(this)});t.addEventListener("touchstart",function(){S(this)});t.appendChild(e);return t};var E=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-arrows-alt-v");t.setAttribute("title",f.config.labels.scaley);t.setAttribute("data-option","-1");t.addEventListener("click",function(){N(this)});t.addEventListener("touchstart",function(){N(this)});t.appendChild(e);return t};var S=function(e){var t=e.getAttribute("data-option");f.cropper.scaleX(t);e.setAttribute("data-option",t*-1)};var N=function(e){var t=e.getAttribute("data-option");f.cropper.scaleY(t);e.setAttribute("data-option",t*-1)};var T=function(){var e=R();var t=F();var a=document.createElement("div");a.appendChild(e);a.appendChild(t);return a};var R=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-arrows-alt");t.setAttribute("title",f.config.labels.move);t.addEventListener("click",function(){f.cropper.setDragMode("move")});t.addEventListener("touchstart",function(){f.cropper.setDragMode("move")});t.appendChild(e);return t};var F=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-crop-alt");t.setAttribute("title",f.config.labels.crop);t.addEventListener("click",function(){f.cropper.setDragMode("crop")});t.addEventListener("touchstart",function(){f.cropper.setDragMode("crop")});t.appendChild(e);return t};var D=function(){var e=L();var t=q();var a=document.createElement("div");a.appendChild(e);a.appendChild(t);return a};var L=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-search-plus");t.setAttribute("title",f.config.labels.zoomin);t.addEventListener("click",function(){f.cropper.zoom(.1)});t.addEventListener("touchstart",function(){f.cropper.zoom(.1)});t.appendChild(e);return t};var q=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-search-minus");t.setAttribute("title",f.config.labels.zoomout);t.addEventListener("click",function(){f.cropper.zoom(-.1)});t.addEventListener("touchstart",function(){f.cropper.zoom(-.1)});t.appendChild(e);return t};var O=function(){var e=I();var t=j();var a=document.createElement("div");a.appendChild(t);a.appendChild(e);return a};var I=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-redo-alt");t.setAttribute("title",f.config.labels.rotateright);t.addEventListener("click",function(){f.cropper.rotate(45)});t.addEventListener("touchstart",function(){f.cropper.rotate(45)});t.appendChild(e);return t};var j=function(){var e=document.createElement("i");var t=document.createElement("button");t.setAttribute("class","btn btn-default");e.setAttribute("class","fa fa-undo-alt");t.setAttribute("title",f.config.labels.rotateleft);t.setAttribute("data-option","-45");t.addEventListener("click",function(){f.cropper.rotate(-45)});t.addEventListener("touchstart",function(){f.cropper.rotate(-45)});t.appendChild(e);return t};this.clear=function(){this.actions.hide();this.image.hide();this.file_input_hidden.val("")};this.setValue=function(e){this.clear();if(e){if(this.fileHandling){var t={fileName:e};if(e.indexOf("%7B%")>=0){t=JSON.parse(decodeURIComponent(e))}this.image.attr("src","download.php?file="+t.fileName);this.image.show();this.actions.show();this.sendData(t)}else{this.file_input_hidden.val(e)}}};this.file.change(m);this.dropzone.on("drop",m);this.edit.click(u);this.remove.click(p)};function timagecropper_start(e,t,a,n,i,r,o,s,l,c){var d=new TImageCropper(e,t,a,n,i,r,o,s,l,c);$("input[name="+e+"]")[0].timagecropper=d}

function tform_send_data(form_name, field, value, fire_events, timeout)
{
    if (parseInt(timeout) > 0)
    {
        setTimeout( function() {
            tform_send_data(form_name, field, value, fire_events, 0);
        }, timeout);
        return;
    }

    try {
        if (field.substr(0,1) == '#')
        {
            var single_field = $(field);
            var array_field  = [];
            var multifile_field  = [];
        }
        else
        {
            var single_field    = $("form[name="+form_name+"] [name='"+field+"']");
            var array_field     = $("form[name="+form_name+"] [name='"+field+"[]']");
            var multifile_field = $("form[name="+form_name+"] [widget='tmultifile'][name='file_"+field+"[]']");
        }
        
        if (single_field.length || array_field.length || multifile_field) {
            if (typeof Adianti.formEventsCounter == 'undefined' || Number.isNaN(Adianti.formEventsCounter)) {
                Adianti.formEventsCounter = 0;
            }
            
            if (Adianti.formEventsCounter == 0 ) {
                if(multifile_field.length) {
                    try {
                        multifile_field[0].tmultifile.send_data(JSON.parse(value));
                    } 
                    catch (e) {
                        multifile_field[0].tmultifile.setValue(value);
                    }
                }
                else if (single_field.length) {
                    
                    if (single_field.attr('widget') == 'thtmleditor') {
                        single_field.summernote( "code", value );
                    }
                    else if (single_field.attr('widget') == 'tdate') {
                        single_field.val(value);
                        single_field.closest('.tdate-group').datepicker('update');
                    }
                    else if (single_field.attr('widget') == 'tcolor') {
                        single_field.colorpicker('setValue', value);
                    }
                    else if (single_field.attr('widget') == 'timagecropper') {
                        single_field[0].timagecropper.setValue(value);
                    }
                    else if (single_field.attr('widget') == 'tfile') {
                        single_field[0].tfile.setValue(value);
                    }
                    else if (single_field.attr('role') == 'tcombosearch') {
                        // only when is different to avoid extra asynchronous event calls on hierarchical combos
                        if (single_field.val() !== value) {
                            var select2_template = function (d) {
                                if (/<[a-z][\s\S]*>/i.test(d.text)) {
                                    return $("<span>"+d.text+"</span>");
                                }
                                else {
                                    return d.text;
                                }
                            };
                            
                            single_field.select2({templateResult: select2_template, templateSelection: select2_template}).val(value).trigger('change.select2');
                        }
                    }
                    else if (single_field.attr('widget') == 'tdbuniquesearch') {
                        var tdbunique_fire_events = fire_events;
                        tdbuniquesearch_set_value(form_name, field, value, function() {
                            // fire events must be after fetch elements from service
                            if (tdbunique_fire_events) {
                                if (single_field.attr('exitaction')) {
                                    tform_events_hang_exec( single_field.attr('exitaction') );
                                }
                                if (single_field.attr('changeaction')) {
                                    tform_events_hang_exec( single_field.attr('changeaction') );
                                }
                            }
                        });
                        // fire events is called within callback
                        fire_events = false;
                    }
                    else if (single_field.attr('component') == 'multisearch') {
                        if (value) {
                        
                            var select2_template = function (d) {
                                if (/<[a-z][\s\S]*>/i.test(d.text)) {
                                    return $("<span>"+d.text+"</span>");
                                }
                                else {
                                    return d.text;
                                }
                            };
                            
                            single_field.select2({templateResult: select2_template, templateSelection: select2_template}).val(value).trigger('change.select2');
                        }
                    }
                    // checkbox is tested here when used alone inside a form (no checkgroup)
                    else if (single_field.attr('type') == 'radio' || single_field.attr('type') == 'checkbox') {
                        if (value) {
                            var radio_input = single_field.filter('[value='+value+']').prop('checked', true);
                            if (radio_input.parent().prop('tagName') == 'LABEL') {
                                radio_input.parent().parent().find('label').removeClass('active');
                                radio_input.parent().toggleClass('active');
                            }
                        }
                    }
                    else {
                        single_field.val( value );
                    }
                    
                    if (fire_events) { 
                        if (single_field.attr('exitaction')) {
                            tform_events_hang_exec( single_field.attr('exitaction') );
                        }
                        if (single_field.attr('changeaction')) {
                            tform_events_hang_exec( single_field.attr('changeaction') );
                        }
                    }
                }
                else if (array_field.length)
                {
                    if (array_field.attr('type') == 'checkbox') {
                        array_field.prop('checked', false);
                        
                        if (value) {
                            array_field.parent().parent().find('label').removeClass('active');
                            var checkeds = JSON.parse(value);
                            $.each(checkeds, function(key, checkvalue) {
                                var check_input = array_field.filter('[value='+checkvalue+']').prop('checked', true);
                                if (check_input.parent().prop('tagName') == 'LABEL') {
                                    check_input.parent().toggleClass('active');
                                }
                            });
                        }
                    }
                    else if (array_field.attr('component') == 'multientry') {
                        if (value) {
                            array_field.empty();
                            var values = JSON.parse(value);
                            $.each(values, function(key, value) {
                                array_field.append($("<option/>").val(value).text(value));
                            });
                            array_field.val(values).trigger("change.select2");
                        }
                    }
                    else if (array_field.attr('component') == 'multisearch' && array_field.attr('widget') !== 'tuniquesearch') {
                        if (value) {
                            var values = JSON.parse(value);
                            
                            var select2_template = function (d) {
                                if (/<[a-z][\s\S]*>/i.test(d.text)) {
                                    return $("<span>"+d.text+"</span>");
                                }
                                else {
                                    return d.text;
                                }
                            };
                            
                            // fi. sendData with multiple values for just one multisearch ['a','c']
                            if (array_field.attr('widget') == 'tmultisearch' || array_field.attr('widget') == 'tdbmultisearch')
                            {
                                array_field.select2({templateResult: select2_template, templateSelection: select2_template}).val(values).trigger('change.select2');
                            }
                            else // fi. sendData with multiple values for many uniques (inside fieldlist) ['a','c']
                            {
                                $.each(values, function(key, each_value) {
                                    var field_id = $($(array_field)[key]).attr('id');
                                    tform_send_data(form_name, '#'+field_id, each_value, fire_events);
                                } );
                                
                                // cancel fire events because it will be fired one by one inside the previous loop
                                fire_events = false;
                            }
                        }
                    }
                    else if (array_field.length) {
                        if (value) {
                            var values = JSON.parse(value);
                            $(array_field).find("option").prop('selected', false);
                            if (array_field.attr('widget') == 'tselect' && array_field.length == 1) // single select[]
                            {
                                $.each(values, function(key, checkvalue) {
                                    $(array_field).find("option").filter('[value="'+checkvalue+'"]').prop('selected', true);
                                } );
                            }
                            else // array of inputs (tfieldlist)
                            {
                                $.each(values, function(key, each_value) {
                                    var field_id = $($(array_field)[key]).attr('id');
                                    tform_send_data(form_name, '#'+field_id, each_value, fire_events);
                                } );
                                
                                // cancel fire events because it will be fired one by one inside the previous loop
                                fire_events = false;
                            }
                        }
                    }
                    
                    if (fire_events) { 
                        if (array_field.attr('exitaction')) {
                            tform_events_hang_exec( array_field.attr('exitaction') );
                        }
                        if (array_field.attr('changeaction')) {
                            tform_events_hang_exec( array_field.attr('changeaction') );
                        }
                    }
                }
            }
            else {
                tform_events_queue_push( function(){
                    tform_send_data(form_name, field, value, fire_events);
                });
            }
        }
    } catch (e) {
        console.log(e);
    }
}

function tentry_numeric_mask(field, decimals, decimal_sep, thousand_sep, reverse, allowNegative)
{
    var selector = 'input[name="'+field+'"]';

    if ($('#'+field).length >0) {
        var selector = '#'+field;
    }

    $(selector).maskMoney({
        prefix: '',
        suffix: '',
        affixesStay: true,
        thousands: thousand_sep,
        decimal: decimal_sep,
        precision: decimals,
        allowZero: true,
        allowNegative: allowNegative,
        formatOnBlur: reverse, // need for reverse mode
        reverse: reverse,
        bringCaretAtEndOnFocus: ! reverse,
        selectAllOnFocus: false,
        allowEmpty: true,
    });
}

function tchecklist_row_enable_check(table_id)
{
    $('table#'+table_id+' tbody tr').click(function(ev) {
        ev.stopImmediatePropagation();
        ev.stopPropagation();
        ev.preventDefault();

        var check   = $(this).find('[type=checkbox]');
        var current = $(check).is(':checked');
        $(check).prop('checked', !current);

        if (!current) {
            $(this).addClass('selected')
        }
        else {
            $(this).removeClass('selected');
        }
    });

    $('table#'+table_id+' tbody tr input[type=checkbox]').click(function(ev) {
        ev.stopPropagation();
        
        var current = $(this).is(':checked');
        var tr = $(this).closest('tr');
        
        if (current) {
            $(tr).addClass('selected')
        }
        else {
            $(tr).removeClass('selected');
        }
    });
}

var TImageCropper = (function (field, title, buttonLabel, serviceAction, fileHandling, base64, webcam, config, name, extension) {

    this.cropper;
    this.url;
    this.name = name;
    this.type = extension;

    this.fileHandling = fileHandling;
    this.serviceAction = serviceAction;
    this.field = field;
    this.title = title;
    this.buttonLabel = buttonLabel;
    this.config = config;
    this.base64 = base64;
    this.webcam = webcam;

    this.file_input_hidden = $('input[name=' + field + ']');
    this.file = $('#tfile_timagecropper_' + field);
    this.image = $('#timagecropper_' + field);
    this.actions = $('#timagecropper_' + field + '+div.timagecropper_actions');
    this.edit = this.actions.find('[action=edit]');
    this.remove = this.actions.find('[action=remove]');

    this.file.click(function(evt){
        // Not use webcan or is mobile
        if(! webcam || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
            return;
        }

        evt.preventDefault();

        var div = document.createElement('div');
        div.id =  'webcam_' + name.replace('.','');
        div.title = 'WebCam';

        $(div).addClass('timagecropper_webcam');

        $('#adianti_div_content').append(div);

        var width = $(window).width() * .75;
        var height = $(window).height() * .75;

        Webcam.set({
            image_format: 'png'
        });
        
        Webcam.set("constraints", {});
        
        tjquerydialog_start('#' + div.id, true, false, false, width, height, 0, 0, 2050, [
            {
                text: 'Capturar',
                click: function() {
                    Webcam.snap( function(data_uri) {
                        var file = dataUrltoFile(data_uri);
                        onCloseWebCam(div.id);
                        onUpload(null, [file]);
                    });
                }
            }
        ], function(){ onCloseWebCam(div.id) }, true, '');
        
        setTimeout(function() { Webcam.attach('#' + div.id) }, 500);
    });

    var onCloseWebCam = function(id)  {
        Webcam.reset();
        $('#' + id).remove();
    };

    this.dropzone = $('#timagecropper_container_' + field);
    
    this.dropzone.on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
    });

    this.dropzone.on('dragover dragenter', function() {
        $('#timagecropper_container_' + field).addClass('highlight');
    });
    
    this.dropzone.on('dragleave dragend drop', function() {
        $('#timagecropper_container_' + field).removeClass('highlight');
    });

    var that = this;

    var onEdit = function (e) {
        __adianti_block_ui();
        that.url = that.image[0].src;
        open();
        __adianti_unblock_ui();
        e.preventDefault();
    }

    var onRemove = function (e) {
        var image = $('#timagecropper_' + that.field)[0];
        if (that.fileHandling) {

            var file_data = getData();
            
            file_data.delFile = file_data.fileName;
            file_data.fileName = '';
            file_data.newFile = '';

            // if delete recently included file (not in server already)
            if (file_data.delFile == file_data.newFile) {
                file_data = '';
            }

            setData(file_data);
            image.src = ' ';
        } else {
            var image = $('#timagecropper_' + that.field)[0];
            that.url = null;
            image.src = ' ';
            setData('');
        }
        
        that.actions.hide();
        e.preventDefault();
    }

    var onUpload = function (e, webcamimages) {
        __adianti_block_ui();
        var files = webcamimages||e.target.files||e.originalEvent.dataTransfer.files;
        
        if (files && files.length > 0) {
            var file = files[0];

            that.name = file.name;
            that.type = file.type;

            processFile(file);
            __adianti_unblock_ui();
        } else {
            __adianti_unblock_ui();
        }
    };

    var processFile = function (file) {
        if (URL) {
            that.url = URL.createObjectURL(file);
            open();
        } else if (FileReader) {
            reader = new FileReader();
            reader.onload = function (e) {
                that.url = reader.result;
                open();
            };
            reader.readAsDataURL(file);
        }
    }

    var init = function () {
        var image = $('#timgagecropper_image_' + that.field)[0];

        var defaults = {
            viewMode: 0,
            highlight: true,
            rotatable: true,
            responsive: true,
            restore: true,
            modal: true,
            guides: true
        };

        if (that.config.aspectRatio) {
            defaults.aspectRatio = that.config.aspectRatio;
        }

        that.cropper = new Cropper(image, defaults);
    }

    var open = function () {
        __adianti_block_ui();
        var div = document.createElement('div');
        var container = document.createElement('div');
        var actionsContainer = document.createElement('div');
        var actions = document.createElement('div');
        var img = document.createElement('img');
        var width = $(window).width() * .95;
        var height = $(window).height() * .90;

        img.src = that.url;
        img.id = 'timgagecropper_image_' + that.field;

        div.title = that.title;
        div.id = 'container_timgagecropper_image_' + that.field;

        actionsContainer.appendChild(actions);
        container.appendChild(img);
        container.appendChild(actionsContainer);
        div.appendChild(container);

        if ($(window).width() < 540) {
            var cropWidth = width - 30;
            var cropHeight = height - 200;
        } else {
            var cropWidth = width - 100;
            var cropHeight = height - 130;
        }
        
        container.setAttribute('style', 'width: ' + cropWidth + 'px; height: ' + cropHeight + 'px');
        
        img.setAttribute('class', 'img_timagecrroper');
        container.setAttribute('class', 'container_timagecrroper');
        actionsContainer.setAttribute('class', 'actions_timagecrroper');
        actionsContainer.setAttribute('class', 'actions_timagecrroper');

        if (that.config.enableButtonDrag) {
            actions.appendChild(getImageCropperDragButton());
        }

        if (that.config.enableButtonScale) {
            actions.appendChild(getImageCropperScaleButton());
        }

        if (that.config.enableButtonZoom) {
            actions.appendChild(getImageCropperZoomButton());
        }

        if (that.config.enableButtonRotate) {
            actions.appendChild(getImageCropperRotateButton());
        }

        if (that.config.enableButtonRotate) {
            actions.appendChild(getImageCropperResetButton());
        }

        $('#adianti_div_content').append(div);

        tjquerydialog_start('#' + div.id, true, false, false, width, height, 0, 0, 2050, [
            {
                text: that.buttonLabel,
                click: save
            }
        ], null, true, '');

        init();

        __adianti_unblock_ui();
    };

    var dataUrltoFile = function (dataurl) {
        var arr = dataurl.split(',');
        var bstr = atob(arr[1]);
        var n = bstr.length;
        var u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }

        var name = (that.name? that.name : 'image' + Math.floor((Math.random() * 1000000) + 1) + '.png' );
        var type = (that.type? that.type : 'image/png') ;
        
        return new File([u8arr], name, { type: type});
    };

    var save = function () {
        __adianti_block_ui();
        var canvas = that.cropper.getCroppedCanvas({
            width: that.config.cropWidth,
            heigth: that.config.cropHeight
        });

        var canvasUrl = canvas.toDataURL(that.type);
        
        $('#timagecropper_' + that.field).attr('src', canvasUrl);
        $('#timagecropper_' + that.field).show();
        
        that.actions.show();

        if (that.base64) {
            that.file_input_hidden.val(canvasUrl);
        }
        else {
            try {
                var file = dataUrltoFile(canvasUrl);
                var form_data = new FormData();
                form_data.append('fileName', file);

                var xhr = new XMLHttpRequest();
                xhr.open('POST', that.serviceAction, true);
                xhr.addEventListener('readystatechange', onReadyStateChange, false);
                xhr.send(form_data);

                if (that.fileHandling) {
                    var file_data = getData();

                    // if delete recently included file (not in server already)
                    if (file_data.fileName && file_data.fileName != file_data.newFile ) {
                        file_data.delFile = file_data.fileName;
                    }
                    
                    file_data.newFile = 'tmp/' + that.name;
                    file_data.fileName = 'tmp/' + that.name;
                    setData(file_data);
                } else {
                    that.file_input_hidden.val(that.name);
                }
            }
            catch (e) {
                __adianti_error('Error', e);
            }
        }
        
        $('#container_timgagecropper_image_' + that.field).closest('.ui-dialog').remove();
        $('#container_timgagecropper_image_' + that.field).remove();

        that.cropper.destroy();
        __adianti_unblock_ui();
    };

    var onReadyStateChange = function(evt)
    {
        var status = null;
        
        try {
            status = evt.target.status;
        }
        catch(e) {
            return;
        }
        
        if (status == '200' && evt.target.readyState == '4' && evt.target.responseText) {
            try {
                var response = JSON.parse( evt.target.responseText );
                
                if ( response.type == 'error' ) {
                    __adianti_error('Error', response.msg);
                }
            }
            catch (e) {
                __adianti_error('Error', e);
            }
        }
    };
    
    var setData = function (data) {
        if (data) {
            $(that.file_input_hidden).val(encodeURIComponent(JSON.stringify(data)));
        }
        else {
            $(that.file_input_hidden).val('');
        }
    };

    that.sendData = setData;

    var getData = function () {
        var file_data = decodeURIComponent(that.file_input_hidden.val());
        var file_data_json = '';

        try {
            file_data_json = file_data ? JSON.parse(file_data) : {};
        }
        catch (e) {
            file_data_json = {};
        }
        return file_data_json;
    };
    
    // Actions

    // Reset    
    var getImageCropperResetButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-sync-alt');
        button.setAttribute('title', that.config.labels.reset);
        button.addEventListener('click', function () {
            that.cropper.reset();
        });
        button.addEventListener('touchstart', function () {
            that.cropper.reset();
        });
        button.appendChild(icon);
        return button;
    }

    // Scale
    var getImageCropperScaleButton = function () {
        var h = getImageCropperScaleHorizontalButton();
        var v = getImageCropperScaleVerticalButton();

        var div = document.createElement('div');
        div.appendChild(h);
        div.appendChild(v);

        return div;
    }

    var getImageCropperScaleHorizontalButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-arrows-alt-h');
        button.setAttribute('title', that.config.labels.scalex);
        button.setAttribute('data-option', '-1');
        button.addEventListener('click', function () {
            imageCropperScaleX(this);
        });
        button.addEventListener('touchstart', function () {
            imageCropperScaleX(this);
        });
        button.appendChild(icon);
        return button;
    }

    var getImageCropperScaleVerticalButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-arrows-alt-v');
        button.setAttribute('title', that.config.labels.scaley);
        button.setAttribute('data-option', '-1');
        button.addEventListener('click', function () { imageCropperScaleY(this) });
        button.addEventListener('touchstart', function () { imageCropperScaleY(this) });
        button.appendChild(icon);
        return button;
    }


    var imageCropperScaleX = function (element) {
        var scale = element.getAttribute('data-option');
        that.cropper.scaleX(scale);
        element.setAttribute('data-option', scale * -1);
    }


    var imageCropperScaleY = function (element) {
        var scale = element.getAttribute('data-option');
        that.cropper.scaleY(scale);
        element.setAttribute('data-option', scale * -1);
    }

    // Drag
    var getImageCropperDragButton = function () {
        var m = getImageCropperDragMoveButton();
        var c = getImageCropperDragCropButton();

        var div = document.createElement('div');
        div.appendChild(m);
        div.appendChild(c);

        return div;
    }

    var getImageCropperDragMoveButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-arrows-alt');
        button.setAttribute('title', that.config.labels.move);
        button.addEventListener('click', function () {
            that.cropper.setDragMode("move");
        });
        button.addEventListener('touchstart', function () {
            that.cropper.setDragMode("move");
        });
        button.appendChild(icon);
        return button;
    }

    var getImageCropperDragCropButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-crop-alt');
        button.setAttribute('title', that.config.labels.crop);
        button.addEventListener('click', function () {
            that.cropper.setDragMode("crop");
        });
        button.addEventListener('touchstart', function () {
            that.cropper.setDragMode("crop");
        });
        button.appendChild(icon);

        return button;
    }

    // Zoom
    var getImageCropperZoomButton = function () {
        var zin = getImageCropperZoomInButton();
        var zout = getImageCropperZoomOutButton();

        var div = document.createElement('div');
        div.appendChild(zin);
        div.appendChild(zout);

        return div;
    }

    var getImageCropperZoomInButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-search-plus');
        button.setAttribute('title', that.config.labels.zoomin);
        button.addEventListener('click', function () {
            that.cropper.zoom(.1);
        });
        button.addEventListener('touchstart', function () {
            that.cropper.zoom(.1);
        });
        button.appendChild(icon);
        return button;
    }

    var getImageCropperZoomOutButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-search-minus');
        button.setAttribute('title', that.config.labels.zoomout);
        button.addEventListener('click', function () {
            that.cropper.zoom(-.1);
        });
        button.addEventListener('touchstart', function () {
            that.cropper.zoom(-.1);
        });
        button.appendChild(icon);
        return button;
    }

    // Rotate
    var getImageCropperRotateButton = function () {
        var rr = getImageCropperRotateRightButton();
        var rl = getImageCropperRotateLeftButton();

        var div = document.createElement('div');
        div.appendChild(rl);
        div.appendChild(rr);

        return div;
    }

    var getImageCropperRotateRightButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-redo-alt');
        button.setAttribute('title', that.config.labels.rotateright);
        button.addEventListener('click', function () {
            that.cropper.rotate(45);
        });
        button.addEventListener('touchstart', function () {
            that.cropper.rotate(45);
        });
        button.appendChild(icon);
        return button;
    }

    var getImageCropperRotateLeftButton = function () {
        var icon = document.createElement('i');
        var button = document.createElement('button');
        button.setAttribute('class', 'btn btn-default');
        icon.setAttribute('class', 'fa fa-undo-alt');
        button.setAttribute('title', that.config.labels.rotateleft);
        button.setAttribute('data-option', '-45');
        button.addEventListener('click', function () {
            that.cropper.rotate(-45);
        });
        button.addEventListener('touchstart', function () {
            that.cropper.rotate(-45);
        });
        button.appendChild(icon);
        return button;
    }
    
    this.clear = function(){
        this.actions.hide();
        this.image.hide();
        this.file_input_hidden.val('');
    }
    
    this.setValue = function(value){
        
        this.clear();
        
        if(value)
        {
            if (this.fileHandling) {
                var data = {"fileName": value};
        
                if(value.indexOf('%7B%') >= 0 )
                {
                    data = JSON.parse(decodeURIComponent(value));
                }
                
                this.image.attr('src', 'download.php?file='+data.fileName);
                this.image.show();
                this.actions.show();    
                
                this.sendData(data);
            } else {
                this.file_input_hidden.val(value);
            }
        }
        
        
    }

    this.file.change(onUpload);
    this.dropzone.on('drop',onUpload);
    this.edit.click(onEdit);
    this.remove.click(onRemove);

});

function MultiFileUploader(input_id, obj_file, service_action, parent_container, complete_action, file_handling, image_gallery, popover)
{
    this.field_name = $('#' + input_id).attr('receiver');
    this.obj_file = obj_file;
    this.service_action = service_action;
    this.complete_action   = complete_action;
    this.file_handling     = file_handling;
    this.image_gallery     = JSON.parse( image_gallery );
    this.popover           = JSON.parse( popover );
    this.parent_container  = $('#'+parent_container);
    this.instances = [];
    var that = this;
    
    // Create structure of status row
    this.createStatusRow = function()
    {
        var input_file = that.parent_container.find('[widget=tmultifile]')[0];
        var input_size = $(input_file).css('width');
        var file_row_wrapper  = $('<div />',  {'class': 'tfile_row_wrapper tfile_row_wrapper-'+input_id});
        var file_row_1        = $('<div />',  {'class': 'tfile_row_1'});
        var file_row_2        = $('<div />',  {'class': 'tfile_row_2'});
        var file_link_wrapper = $('<div />',  {'class': 'tfile_link_wrapper', 'style': 'width: calc('+ input_size +' - 25px)'});
        var file_del_icon     = $('<span />', {'class': 'tfile_del_icon fa fa-minus-circle gray', 'title': 'Remover'});
        var file_progress_bar = $('<div />',  {'class': 'progress-bar progress-bar-success', 'style': 'width: 0%; height: 2px;'});
        var file_input_hidden = $('<input />',{type: 'hidden', name: that.field_name+'[]'});
        
        if (that.image_gallery.enabled == '1')
        {
            $(file_link_wrapper).css('width','unset');
            $(file_row_wrapper).css('border','1px solid gray');
            $(file_row_wrapper).css('border-radius','3px');
            $(file_row_wrapper).css('margin','2px');
            $(file_row_wrapper).css('display','inline-block');
        }
        
        that.file_row_wrapper  = file_row_wrapper;
        that.file_input_hidden = file_input_hidden;
        that.file_progress_bar = file_progress_bar;
        that.file_link_wrapper = file_link_wrapper;
        
        //that.parent_container.children('.tfile_row_wrapper').remove();
        that.parent_container.append(file_row_wrapper);
        file_row_wrapper.append(file_row_1);
        file_row_wrapper.append(file_row_2);
        file_row_1.append(file_input_hidden, file_link_wrapper, file_del_icon);
        file_row_2.append(file_progress_bar);
        
        $(file_del_icon).click(
            function(){
                var file_data = that.getData();
                
                file_row_wrapper.hide();
                that.parent_container.children('i').attr({'class' : '', 'title' : ''});
                that.parent_container.find('[widget=tmultifile]').css('padding-left', '5px');
                
                // check the file to be deleted
                file_data.delFile = file_data.fileName;
                
                // if delete recently included file (not in server already)
                if (file_data.delFile == file_data.newFile) {
                    file_data = '';
                    that.setData(file_data);
                    file_row_wrapper.remove();
                }
                
                that.setData(file_data);
            }
        );
        
        return file_row_wrapper;
    }

    this.createInputHidden = function(value)
    {
        var file_input_hidden = $('<input />',{
            type: 'hidden',
            name: that.field_name+'[]',
            widget: "thidden",
            value: value
        });

        that.parent_container.append(file_input_hidden);
        
        return file_input_hidden;
    };
    
    // Show file
    this.showFile = function(file_data)
    {
        if (typeof file_data == 'undefined')
        {
            var file_data  = this.getData();
        }
        var file_name = file_data.fileName;
        
        if (file_name) {
            var file_row_wrapper  = that.file_row_wrapper;
            var file_link_wrapper = file_row_wrapper.find('.tfile_link_wrapper');
            file_row_wrapper.find('.progress-bar').css('width', '100%');
            
            if ($.inArray( file_name.split('.').pop().toLowerCase(), [ "png", "jpg", "jpeg", "gif", "svg", "webp", "ico", "fav" ] ) > -1) {
                var pop_template = '<div class="popover" role="tooltip" style="z-index:100000;max-width:800px"><div class="arrow"></div><h3 class="popover-title popover-header"></h3><div class="popover-content popover-body"><div class="data-content"></div></div></div>';
                var pop_content  = '<img style="max-width:460px" src="download.php?file={file_name}">';
                
                if (that.popover.content) {
                    pop_content = atob(that.popover.content);
                }
                
                pop_content = pop_content.replace('{file_name}', file_name);
                if (that.image_gallery.enabled == '1')
                {
                    var file_link = $('<a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank' });
                    var image = $('<img />', { 'src': 'download.php?file='+file_name }).height(that.image_gallery.height).width(that.image_gallery.width);
                    file_link.append(image);
                    
                    if (that.popover.enabled == '1') {
                        file_link_wrapper.popover({
                            trigger: "hover",
                            'content': pop_content,
                            'html' : true,
                            'container': 'body',
                            'template': pop_template,
                            title: that.popover.title || ""
                        });
                    }
                }
                else
                {
                    var file_link = $('<a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank'});
                    
                    if (that.popover.enabled == '1') {
                        file_link.popover({
                            trigger: "hover",
                            'content': pop_content,
                            'html' : true,
                            'container': 'body',
                            'template': pop_template,
                            title: that.popover.title || ""
                        });
                    }
                }
            }
            else {
                var file_link = $('<a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank' });
            }
            
            if (that.image_gallery.enabled != '1')
            {
                file_link.append(file_name);
            }
            file_link_wrapper.html(file_link);
    }
    };
    
    // Get file data
    this.getData = function()
    {
        var file_data = decodeURIComponent(that.file_input_hidden.val());
        var file_data_json = '';
        
        try {
            file_data_json = file_data ? JSON.parse(file_data) : {};
        }
        catch(e) {
            file_data_json = {};
        }
        return file_data_json;
    };
    
    // Set file data
    this.setData = function(data)
    {
        if (data) {
            $(that.file_input_hidden).val(encodeURIComponent(JSON.stringify(data)));
        }
        else {
            $(that.file_input_hidden).val('');
        }
    };
    
    // Ajax uploads are supported
    this.supportAjaxUploadWithProgress = function()
    {
        return this.supportFileAPI() && this.supportAjaxUploadProgressEvents() && this.supportFormData();
    };
    
    // File API supported?
    this.supportFileAPI = function()
    {
        var fi = document.createElement('INPUT');
        fi.type = 'file';
        return 'files' in fi;
    };
        
    // Progress events supported?
    this.supportAjaxUploadProgressEvents = function()
    {
        var xhr = new XMLHttpRequest();
        return !! (xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));
    };
    
    // FormData supported
    this.supportFormData = function()
    {
        return !! window.FormData;
    };
    
    // Start upload
    this.initFileUpload = function()
    {
        //if (that.file_handling) {
            this.createStatusRow();
        //}
        
        if (this.supportAjaxUploadWithProgress()) {
            var form_data = new FormData();
            var file = that.obj_file;
            form_data.append('fileName', file);
            this.sendXHRequest(form_data, that.service_action);
        }
    };
    
    // Send request
    this.sendXHRequest = function(form_data, uri)
    {
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('loadstart', this.onLoadStart, false);
        xhr.upload.addEventListener('progress', this.onProgress, false);
        xhr.upload.addEventListener('load', this.onLoad, false);
        xhr.addEventListener('readystatechange', this.onReadyStateChange, false);
        xhr.open('POST', uri, true);
        xhr.send(form_data);
    };
    
    // Handle the start of the upload
    this.onLoadStart = function(evt)
    {
        if( that.parent_container.children('i').length == 0 ) {
            that.parent_container.prepend($('<i>'));
        }
        that.parent_container.find('[widget=tmultifile]').css('padding-left', '20px');
        that.parent_container.children('i').attr({'class'   : 'fa fa-spinner fa-spin fa-fw blue file-response-icon',
                                                'title' : '...'});
    };
    
    // Handle the end of the upload
    this.onLoad = function(evt)
    {
    };
    
    // Handle the progress
    this.onProgress = function(evt)
    {
        if( evt.lengthComputable ) {
            var percent = Math.round(evt.loaded * 100 / evt.total);
            that.file_progress_bar.css('width',percent+'%').css('height', 2);
            that.file_link_wrapper.html(percent + '%');
        }
    };
    
    // Handle the response from the server
    this.onReadyStateChange = function(evt)
    {
        var status = null;
        
        try {
            status = evt.target.status;
        }
        catch(e) {
            return;
        }
        
        if (status == '200' && evt.target.readyState == '4' && evt.target.responseText) {
            try {
                var response = JSON.parse( evt.target.responseText );
                
                if ( response.type == 'success' ) {
                    if (that.file_handling) {
                        var file_data      = that.getData();
                        file_data.newFile  = 'tmp/' + response.fileName;
                        file_data.fileName = 'tmp/' + response.fileName;
                        
                        that.setData(file_data);
                        that.showFile(file_data);
                    }
                    else {
                        that.file_input_hidden.val(response.fileName);
                        that.file_link_wrapper.html(response.fileName);
                    }
                    
                    that.showMessage('success', 'Sucesso');
                    if (this.readyState == 4 && typeof(that.complete_action) == "function") {
                        that.complete_action();
                    }
                }
                else {
                    that.file_row_wrapper.remove();
                    that.showMessage('error', response.msg);
                }
            }
            catch (e)
            {
                that.file_row_wrapper.remove();
                
                if (typeof response == "undefined") {
                    that.showMessage('error', evt.target.responseText);
                }
                else {
                    that.showMessage('error', e);
                }
            }
        }
    };
    
    // Show message
    this.showMessage = function(type, message)
    {
        if (type == 'success') {
            that.parent_container.find('[widget=tmultifile]').css('padding-left', '20px');
            that.parent_container.children('i').attr({ 'class' : 'far fa-check-circle green file-response-icon',
                                                    'title' : message });
        }
        else if (type == 'error') {
            that.parent_container.find('[widget=tmultifile]').css('padding-left', '20px');
            that.parent_container.children('i').attr({ 'class' : 'fa fa-exclamation-circle red file-response-icon',
                                                    'title' : message });
        }
    };
    
    this.clear = function()
    {
        $('.tfile_row_wrapper-'+input_id).each(function(){
            $(this).find('input').each(function(){
                $(this).val('');
            });
            
            $(this).remove();
        });
        
        that.parent_container.children('i').attr({'class' : '', 'title' : ''});
        that.parent_container.find('[widget=tmultifile]').css('padding-left', '5px');
        
        $('[name="file_'+this.field_name+'[]"]').val('');
        $(this.file_input_hidden).val('');
        $('#'+this.input_id).val('');
    }
    
    this.setValue = function(values)
    {
        this.clear();
        
        if(!values) 
        {
            return;
        }
        
        try {
            values = JSON.parse(values);
        } catch (e) {
            
        }
        
        for (var index in values) 
        {
            
            var value = values[index];
            var data = {"idFile" : index, "fileName": value};
            
            
            
            if(value.indexOf('%7B%') >= 0 )
            {
                data = JSON.parse(decodeURIComponent(value));
            }
            
            if(this.file_handling) 
            {
                this.createStatusRow();
                this.setData(data);
                this.showFile();
            } 
            else 
            {
                this.createInputHidden(value);
            }
        }
    }
    
    this.addInstance = function(instance)
    {
        this.instances.push(instance);
    }
}

function FileUploader(input_id, parent_container, service_action, complete_action, error_action, file_handling, image_gallery, popover)
{
    this.field_name       = $('#' + input_id).attr('receiver');
    this.input_id         = input_id;
    this.service_action   = service_action;
    this.parent_container = $('#'+parent_container);
    this.complete_action  = complete_action;
    this.error_action     = error_action;
    this.file_handling    = file_handling;
    this.image_gallery    = JSON.parse( image_gallery );
    this.popover          = JSON.parse( popover );
    this.obj_file         = document.getElementById( this.input_id );
    
    var that = this;
    
    // Create structure of status row
    this.createStatusRow = function()
    {
        var input_file = that.parent_container.find('[widget=tfile]')[0];
        var input_size = $(input_file).css('width');
        var file_row_wrapper  = $('<div />',  {'class': 'tfile_row_wrapper', 'style': 'display:none'});
        var file_row_1        = $('<div />',  {'class': 'tfile_row_1'});
        var file_row_2        = $('<div />',  {'class': 'tfile_row_2'});
        var file_link_wrapper = $('<div />',  {'class': 'tfile_link_wrapper', 'style': 'width: calc('+ input_size +' - 25px)'});
        var file_del_icon     = $('<span />', {'class': 'tfile_del_icon fa fa-minus-circle gray', 'title': 'Remover'});
        var file_progress_bar = $('<div />',  {'class': 'progress-bar progress-bar-success', 'style': 'width: 0%; height: 2px;'});
        var file_input_hidden = $('<input />',{type: 'hidden', name: that.field_name, widget: 'tfile'});
        
        if (that.image_gallery.enabled == '1')
        {
            $(file_link_wrapper).css('width','unset');
            $(file_row_wrapper).css('border','1px solid gray');
            $(file_row_wrapper).css('border-radius','3px');
            $(file_row_wrapper).css('margin','2px');
        }
        
        that.file_row_wrapper  = file_row_wrapper;
        that.file_input_hidden = file_input_hidden;
        that.file_progress_bar = file_progress_bar;
        that.file_link_wrapper = file_link_wrapper;
        
        that.parent_container.children('.tfile_row_wrapper').remove();
        that.parent_container.append(file_row_wrapper);
        file_row_wrapper.append(file_row_1);
        file_row_wrapper.append(file_row_2);
        file_row_1.append(file_input_hidden, file_link_wrapper, file_del_icon);
        file_row_2.append(file_progress_bar);
        
        $(file_del_icon).click(
            function(){
                var file_data = that.getData();
                
                file_row_wrapper.hide();
                that.parent_container.children('i').attr({'class' : '', 'title' : ''});
                that.parent_container.find('[widget=tfile]').css('padding-left', '5px');
                
                // check the file to be deleted
                file_data.delFile = file_data.fileName;
                
                // if delete recently included file (not in server already)
                if (file_data.delFile == file_data.newFile) {
                    file_data = '';
                }
                
                that.setData(file_data);
            }
        );
        
        return file_row_wrapper;
    }
    
    this.clear = function()
    {
        that.file_row_wrapper.hide();
        that.parent_container.children('i').attr({'class' : '', 'title' : ''});
        that.parent_container.find('[widget=tfile]').css('padding-left', '5px');
        $(that.file_input_hidden).val('');
        $('#'+this.input_id).val('');
    }
    
    // Show file
    this.showFile = function(file_data)
    {
        if (typeof file_data == 'undefined')
        {
            var file_data  = this.getData();
        }
        var file_name = file_data.fileName;
        
        if (file_name) {
            var file_row_wrapper  = that.file_row_wrapper;
            var file_link_wrapper = file_row_wrapper.find('.tfile_link_wrapper');
            file_row_wrapper.find('.progress-bar').css('width', '100%');
            
            if ($.inArray( file_name.split('.').pop().toLowerCase(), [ "png", "jpg", "jpeg", "gif", "svg", "webp", "ico", "fav" ] ) > -1) {
                var pop_template = '<div class="popover" role="tooltip" style="z-index:100000;max-width:800px"><div class="arrow"></div><h3 class="popover-title popover-header"></h3><div class="popover-content popover-body"><div class="data-content"></div></div></div>';
                var pop_content  = '<img style="max-width:460px" src="download.php?file={file_name}">';
                
                if (that.popover.content) {
                    pop_content = atob(that.popover.content);
                }
                
                pop_content = pop_content.replace('{file_name}', file_name);
                if (that.image_gallery.enabled == '1')
                {
                    var file_link = $('<a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank' });
                    var image = $('<img />', { 'src': 'download.php?file='+file_name }).height(that.image_gallery.height).width(that.image_gallery.width);
                    file_link.append(image);
                    
                    if (that.popover.enabled == '1') {
                        file_link.popover({
                            trigger: "hover",
                            'content': pop_content,
                            'html' : true,
                            'container': 'body',
                            'template': pop_template,
                            title: that.popover.title || ""
                        });
                    }
                }
                else
                {
                    var file_link = $('<a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank'});
                    
                    if (that.popover.enabled == '1') {
                        file_link.popover({
                            trigger: "hover",
                            'content': pop_content,
                            'html' : true,
                            'container': 'body',
                            'template': pop_template,
                            title: that.popover.title || ""
                        });
                    }
                }
            }
            else {
                var file_link = $('<a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank' });
            }
            that.file_row_wrapper.show();
            if (that.image_gallery.enabled != '1')
            {
                file_link.append(file_name);
            }
            file_link_wrapper.html(file_link);
       }
    };
    
    // Get file data
    this.getData = function()
    {
        var file_data = decodeURIComponent(that.file_input_hidden.val());
        var file_data_json = '';
        
        try {
            file_data_json = file_data ? JSON.parse(file_data) : {};
        }
        catch(e) {
            file_data_json = {};
        }
        return file_data_json;
    };
    
    // Set file data
    this.setData = function(data)
    {
        that.clear();
        
        if (data) {
            $(that.file_input_hidden).val(encodeURIComponent(JSON.stringify(data)));
        }
    };
    
    // Ajax uploads are supported
    this.supportAjaxUploadWithProgress = function()
    {
        return this.supportFileAPI() && this.supportAjaxUploadProgressEvents() && this.supportFormData();
    };
    
    // File API supported?
    this.supportFileAPI = function()
    {
        var fi = document.createElement('INPUT');
        fi.type = 'file';
        return 'files' in fi;
    };
        
    // Progress events supported?
    this.supportAjaxUploadProgressEvents = function()
    {
        var xhr = new XMLHttpRequest();
        return !! (xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));
    };
    
    // FormData supported
    this.supportFormData = function()
    {
        return !! window.FormData;
    };
    
    // Start upload
    this.initFileUpload = function()
    {
        if (that.file_handling) {
            //this.createStatusRow(); // do recreate row, because it would remove old data.fileName (needed for exclusion/data.delFile)
        }
        
        if (this.supportAjaxUploadWithProgress()) {
            var form_data = new FormData();
            var file = that.obj_file.files[0];
            form_data.append('fileName', file);
            this.sendXHRequest(form_data, that.service_action);
        }
    };
    
    // Send request
    this.sendXHRequest = function(form_data, uri)
    {
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('loadstart', this.onLoadStart, false);
        xhr.upload.addEventListener('progress', this.onProgress, false);
        xhr.upload.addEventListener('load', this.onLoad, false);
        xhr.addEventListener('readystatechange', this.onReadyStateChange, false);
        xhr.open('POST', uri, true);
        xhr.send(form_data);
    };
    
    // Handle the start of the upload
    this.onLoadStart = function(evt)
    {
        if( that.parent_container.children('i').length == 0 ) {
            that.parent_container.prepend($('<i>'));
        }
        if (that.file_handling) {
            that.file_row_wrapper.show();
        }
        that.parent_container.find('[widget=tfile]').css('padding-left', '20px');
        that.parent_container.children('i').attr({'class'   : 'fa fa-spinner fa-spin fa-fw blue file-response-icon',
                                                  'title' : '...'});
    };
    
    // Handle the end of the upload
    this.onLoad = function(evt)
    {
    };
    
    // Handle the progress
    this.onProgress = function(evt)
    {
        if( evt.lengthComputable && that.file_handling) {
            var percent = Math.round(evt.loaded * 100 / evt.total);
            that.file_progress_bar.css('width',percent+'%').css('height', 2);
            that.file_link_wrapper.html(percent + '%');
        }
    };
    
    // Handle the response from the server
    this.onReadyStateChange = function(evt)
    {
        var status = null;
        
        try {
            status = evt.target.status;
        }
        catch(e) {
            return;
        }
        
        if (status == '200' && evt.target.readyState == '4' && evt.target.responseText) {
            try {
                var response = JSON.parse( evt.target.responseText );
                
                if ( response.type == 'success' ) {
                    if (that.file_handling) {
                        var file_data = that.getData();
                        
                        // if there was already a file, then tell server to delete it
                        if (file_data.fileName) {
                            file_data.delFile = file_data.fileName;
                        }
                        
                        file_data.newFile  = 'tmp/' + response.fileName;
                        file_data.fileName = 'tmp/' + response.fileName;
                        that.setData(file_data);
                        that.showFile(file_data);
                    }
                    else {
                        var file_input_hidden = $('#'+that.input_id).parent().children('input[type=hidden]');
                        $(file_input_hidden).val(response.fileName);
                    }
                    
                    that.showMessage('success', 'Sucesso');
                    if (this.readyState == 4 && typeof(that.complete_action) == "function") {
                        that.complete_action();
                    }
                }
                else {
                    if (that.file_handling) {
                        that.file_row_wrapper.remove();
                    }
                    if (typeof(that.error_action) == "function") {
                        that.error_action();
                    }
                    that.showMessage('error', response.msg);
                }
            }
            catch (e) {
                if (typeof(that.error_action) == "function") {
                    that.error_action();
                }
                
                if (that.file_handling) {
                    that.file_row_wrapper.remove();
                }
                if (typeof response == "undefined") {
                    that.showMessage('error', evt.target.responseText);
                }
                else {
                    that.showMessage('error', e);
                }
            }
        }
    };
    
    // Show message
    this.showMessage = function(type, message)
    {
        if (type == 'success') {
            that.parent_container.find('[widget=tfile]').css('padding-left', '20px');
            that.parent_container.children('i').attr({ 'class' : 'far fa-check-circle green file-response-icon',
                                                       'title' : message });
        }
        else if (type == 'error') {
            that.parent_container.find('[widget=tfile]').css('padding-left', '20px');
            that.parent_container.children('i').attr({ 'class' : 'fa fa-exclamation-circle red file-response-icon',
                                                       'title' : message });
            __adianti_error('Error', message);
        }
    };
    
    this.setValue = function(value)
    {
        this.clear();
        if(value)
        {
            var data = {"fileName": value};
        
            if(value.indexOf('%7B%') >= 0 )
            {
                data = JSON.parse(decodeURIComponent(value));
            }
            
            this.setData(data);    
        }
        
        this.showFile();
    }
}

function tfieldlist_add_rows(name, rows)
{
    for (n=1; n<=rows; n++)
    {
        ttable_clone_previous_row( $('[name='+name+'] tbody') );
    }
}

function tfieldlist_execute_scripts(container, filter, callback)
{
    var scripts = $(container).find('script');
    $.each(scripts, function(sindex, script)
    {
        var text = $(script).text();
        text = callback(text);

        if (text.trim().split('_')[0] == filter) {
            $(script).html('<script>'+text+'</script>');
        }
    });
}

function thtmleditor_start(objectId, width, height, lang, options) {
    
    var attributes = {
        dialogsInBody: true,
        fontSizes: ['8', '9', '10', '11', '12', '14', '18', '24', '36', '48' , '64', '82', '150'],
        width: width,
        height: height,
        lang: lang,
        toolbar: [
          ['undoredo', ['undo','redo']],
          ['style', ['style', 'bold', 'italic', 'underline','clear']],
          ['font', ['fontname', 'fontsize', 'color']],
          ['para', ['ul', 'ol', 'paragraph', 'height']],
          ['insert', ['table', 'link', 'picture', 'hr']],
          ["view", ["fullscreen", "codeview", "help"]],
       ]
    };
    
    options = Object.assign(attributes, JSON.parse( options) );
    
    if (typeof options.completion !== 'undefined') {
        if (typeof summernote_wordlist == 'undefined') {
            summernote_wordlist = {};
        }
        summernote_wordlist[objectId] = options.completion;
        
        options.hint = {
            match: /\b(\w{1,})$/,
            search: function (keyword, callback) {
              callback($.grep(summernote_wordlist[objectId], function (item) {
                return item.indexOf(keyword) === 0;
              }));
          }
        };
    }
    
    if (options.airMode == true)
    {
        setTimeout( function() {
            $('#'+objectId).parent().find('.note-editable').height(height + 'px').css('overflow', 'auto');
        }, 1);
    }
    
    $('#'+objectId).summernote(options);
    
    if (typeof $('#'+objectId).next('.note-editor')[0] !== 'undefined')
    {
        var container = $('#'+objectId).next('.note-editor')[0];
        $(container).css('margin', $('#'+objectId).css('margin'));
    }
}